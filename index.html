<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>é­”éˆæ¨™ç¤ºè¼”åŠ©å™¨</title>

<style>
  :root { color-scheme: dark; }

  /* ====== âœ… å»ºè­°æ•¸å€¼ï¼ˆä½ è¦æ”¹åªå‹•é€™è£¡ï¼‰ ====== */
  :root{
    /* åœ–ç¤ºè¦–è¦ºå¤§å°ï¼ˆä¸ç­‰æ–¼å¯é»æ“Šç†±å€ï¼‰ */
    --marker-size-desktop: 22px;
    --marker-size-mobile: 34px;

    /* âœ… å¯é»æ“Šç†±å€ï¼ˆé˜²èª¤è§¸æ ¸å¿ƒï¼‰ */
    --hitbox-desktop: 14px;  /* æ»‘é¼  */
    --hitbox-mobile: 20px;   /* è§¸æ§ */

    /* âœ… é«˜å…‰ï¼ˆåœˆåœˆæ›´å°ã€ä½†æ›´äº®æ›´é›†ä¸­ï¼‰ */
    --hl-scale: 1.03;
    --hl-outline: 1.5px;
    --hl-offset: 1px;
    --hl-glow: 6px;

    /* è¨»è¨˜ assign æ¡† */
    --as-outline: 1.25px;
    --as-offset: 1px;
  }
  :root{
  /* ...ä½ åŸæœ¬çš„è®Šæ•¸... */

  /* âœ… åœ°åœ–é¡¯ç¤ºå¤§å°ï¼ˆåªæ”¹é€™è£¡å°±å¥½ï¼‰ */
  --map-max-width-desktop: 1500px; /* é›»è…¦ï¼šåœ°åœ–æœ€å¤§å¯¬ */
  --map-vw-desktop: 98vw;          /* é›»è…¦ï¼šç›¸å°è¢å¹•å¯¬ï¼ˆè¶Šå¤§è¶Šæ»¿ç‰ˆï¼‰ */

  --map-max-width-mobile: 100vw;   /* æ‰‹æ©Ÿï¼šåœ°åœ–æœ€å¤§å¯¬ */
  --map-vw-mobile: 98vw;           /* æ‰‹æ©Ÿï¼šç›¸å°è¢å¹•å¯¬ */
  
  /* âœ… åœ°åœ–é«˜åº¦ï¼šä¿ç•™å¤šå°‘ç©ºé–“çµ¦ header/é¢æ¿ï¼ˆè¶Šå°åœ°åœ–è¶Šå¤§ï¼‰ */
  --map-top-bottom-gap-desktop: 200px;
  --map-top-bottom-gap-mobile: 210px;
}


  body{
    margin:0;
    background:#111;
    color:#fff;
    font-family: system-ui, -apple-system, "Segoe UI", "Noto Sans TC", sans-serif;
  }
  header{
    position: sticky;
    top:0;
    background: rgba(17,17,17,.92);
    backdrop-filter: blur(8px);
    border-bottom: 1px solid rgba(255,255,255,.08);
    padding: 12px 14px;
    z-index:10;
  }
  h1{
    margin:0 0 10px 0;
    font-size:18px;
    font-weight:650;
  }
  .row{
    display:flex;
    flex-wrap:wrap;
    gap:8px;
    align-items:center;
  }
  select, input[type="text"], button, textarea{
    background:#1b1b1b;
    color:#fff;
    border:1px solid rgba(255,255,255,.14);
    border-radius:10px;
    padding:8px 10px;
    font-size:14px;
    outline:none;
  }
  input[type="text"]{ width:220px; }
  button{ cursor:pointer; }
  textarea{ width:100%; min-height:72px; resize: vertical; }

  button.primary{ border-color: rgba(130,200,255,.6); }
  button.danger { border-color: rgba(255,120,120,.6); }

  button.active{
    border-color: rgba(120,255,180,.7);
    box-shadow: 0 0 0 2px rgba(120,255,180,.15) inset;
  }
  .hint{
    margin-top:10px;
    font-size:12px;
    color: rgba(255,255,255,.72);
    line-height:1.45;
  }
  .hint-strong{ color:#fbbf24; font-weight:650; }
  .hint-info  { color:#7dd3fc; }
  .hint-title { color:#a7f3d0; font-weight:650; }
  .hint-warning{ color:#fb7185; font-weight:650; }
  .hint-line{ margin:4px 0; }

  main{ padding:14px; }

  #mapWrap{
    display:flex;
    gap:12px;
    align-items:flex-start;
    justify-content:center;
  }

  #legend{
    width:260px;
    max-width:45vw;
    background: rgba(255,255,255,.04);
    border:1px solid rgba(255,255,255,.10);
    border-radius:14px;
    padding:10px;
    position: sticky;
    top:92px;
  }

  .legend-title{
    font-size:13px;
    font-weight:700;
    margin:2px 0 10px 0;
    color: rgba(255,255,255,.90);
  }

  .legend-item{
    display:flex;
    align-items:center;
    gap:10px;
    padding:8px 8px;
    border-radius:12px;
  }
  .legend-item:hover{ background: rgba(255,255,255,.05); }

  .legend-icon{
    width:22px;
    height:22px;
    border-radius:6px;
    flex:0 0 auto;
  }

  .legend-text{ font-size:13px; color: rgba(255,255,255,.82); line-height:1.2; }
  .legend-state{ font-size:12px; color: rgba(255,255,255,.55); margin-left:auto; }

  .panel-sep{ margin:10px 0; border-top:1px solid rgba(255,255,255,.10); }

  .stats-title{
    font-size:13px;
    font-weight:700;
    margin:10px 0 8px 0;
    color: rgba(255,255,255,.90);
  }

  .stats-row{
    display:flex;
    align-items:center;
    gap:8px;
    padding:7px 8px;
    border-radius:12px;
  }
  .stats-row:hover{ background: rgba(255,255,255,.05); }

  .stats-name{
    font-size:13px;
    color: rgba(255,255,255,.86);
    overflow:hidden;
    text-overflow:ellipsis;
    white-space:nowrap;
    flex:1 1 auto;
  }

  .stats-counts{
    display:flex;
    gap:10px;
    flex:0 0 auto;
    font-size:12px;
    color: rgba(255,255,255,.68);
  }

  .pill{
    display:inline-flex;
    align-items:center;
    gap:6px;
    padding:3px 8px;
    border-radius:999px;
    border:1px solid rgba(255,255,255,.12);
    background: rgba(0,0,0,.12);
  }
  .pill img{ width:14px; height:14px; border-radius:4px; }

  .fail-title{
    font-size:13px;
    font-weight:700;
    margin:10px 0 8px 0;
    color: rgba(255,255,255,.90);
  }
  .fail-item{
    font-size:12px;
    color: rgba(255,255,255,.72);
    padding:6px 8px;
    border-radius:12px;
    border:1px dashed rgba(255,120,120,.35);
    background: rgba(255,120,120,.06);
    margin:6px 0;
    line-height:1.35;
  }
  .fail-empty{ font-size:12px; color: rgba(255,255,255,.55); padding:6px 8px; }

#mapContainer{
  position:relative;
  display:inline-block;
  margin:8px auto 18px auto;
  border-radius:14px;
  overflow:hidden;
  box-shadow: 0 10px 40px rgba(0,0,0,.35);
  border:1px solid rgba(255,255,255,.08);

  /* âœ… é›»è…¦é è¨­ */
  max-width: min(var(--map-max-width-desktop), var(--map-vw-desktop));
  max-height: calc(100vh - var(--map-top-bottom-gap-desktop));
}

#mapImg{
  display:block;
  width:100%;
  height:auto;

  /* âœ… è·Ÿ container ä¸€è‡´ */
  max-height: calc(100vh - var(--map-top-bottom-gap-desktop));
  object-fit: contain;
}


  #mapImg{
    display:block;
    width:100%;
    height:auto;
    max-height: calc(100vh - 240px);
    object-fit: contain;
  }

  /* ====== âœ… é»ä½ï¼šè¦–è¦º & å¯é»æ“Šç†±å€åˆ†é›¢ï¼ˆé˜²èª¤è§¸ï¼‰ ====== */
  .marker{
    position:absolute;
    transform: translate(-50%, -50%);
    user-select:none;
    z-index:5;
  }

  /* è¦–è¦ºåœ–ç¤ºï¼ˆå¯åšé«˜å…‰ï¼‰ */
  .marker-ico{
    width: var(--marker-size-desktop);
    height: var(--marker-size-desktop);
    display:block;
    pointer-events:none; /* âœ… ä¸è®“åœ–ç¤ºæœ¬é«”åƒåˆ°é»æ“Š */
    transition: transform .12s ease, filter .12s ease, outline-color .12s ease;
    border-radius: 8px;
  }

  /* âœ… çœŸæ­£å¯é»æ“Šçš„ç†±å€ï¼ˆç¸®å°ï¼‰ */
  .marker-hit{
    position:absolute;
    left:50%;
    top:50%;
    transform: translate(-50%, -50%);
    width: var(--hitbox-desktop);
    height: var(--hitbox-desktop);
    border-radius: 8px;
    cursor:pointer;
    background: transparent;
    border:none;
    padding:0;
    margin:0;
    outline: none;
  }

  .marker:hover .marker-ico{
    filter: drop-shadow(0 0 4px rgba(255,255,255,.18));
  }

  /* âœ… é«˜å…‰æ›´å°ã€ä½†æ›´é›†ä¸­ */
  .marker.hl .marker-ico{
    transform: scale(var(--hl-scale));
    filter: drop-shadow(0 0 var(--hl-glow) rgba(255,230,140,.30));
    outline: var(--hl-outline) solid rgba(255,210,120,.62);
    outline-offset: var(--hl-offset);
  }

  /* âœ… è¨»è¨˜ assign æ¡†ï¼ˆç¨å°ï¼‰ */
  .marker.assign .marker-ico{
    outline: var(--as-outline) solid rgba(120,255,180,.55);
    outline-offset: var(--as-offset);
  }

  @media (max-width: 920px){
    .marker-ico{
      width: var(--marker-size-mobile);
      height: var(--marker-size-mobile);
    }
    .marker-hit{
      width: var(--hitbox-mobile);
      height: var(--hitbox-mobile);
    }
  }
  @media (max-width: 920px){
  #mapContainer{
    max-width: min(var(--map-max-width-mobile), var(--map-vw-mobile));
    max-height: calc(100vh - var(--map-top-bottom-gap-mobile));
  }
  #mapImg{
    max-height: calc(100vh - var(--map-top-bottom-gap-mobile));
  }
}


  .badge{
    display:inline-flex;
    align-items:center;
    gap:6px;
    padding:6px 10px;
    border:1px dashed rgba(255,255,255,.18);
    border-radius:999px;
    font-size:12px;
    color: rgba(255,255,255,.8);
  }
  .badge b{ color: rgba(255,255,255,.95); }

  .menu-group{ display:flex; gap:8px; flex-wrap:wrap; }
  .dropdown{ position:relative; }

  .menu-btn{
    background:#1b1b1b;
    color:#fff;
    border:1px solid rgba(255,255,255,.14);
    border-radius:10px;
    padding:8px 12px;
    cursor:pointer;
  }

  .menu{
    position:absolute;
    top:calc(100% + 6px);
    left:0;
    min-width:220px;
    background:#181818;
    border:1px solid rgba(255,255,255,.12);
    border-radius:12px;
    box-shadow:0 12px 30px rgba(0,0,0,.4);
    padding:6px;
    display:none;
    z-index:50;
  }
  .dropdown.open .menu{ display:block; }

  .menu button{
    width:100%;
    text-align:left;
    background:transparent;
    border:none;
    color:#fff;
    padding:8px 10px;
    border-radius:8px;
    cursor:pointer;
  }
  .menu button:hover{ background: rgba(255,255,255,.08); }
  .menu .danger{ color:#ff7b7b; }
  .menu hr{
    border:none;
    border-top:1px solid rgba(255,255,255,.1);
    margin:6px 0;
  }

  @media (max-width: 920px){
    header{ padding:10px 10px; }
    h1{ font-size:16px; }
    .row{ gap:8px; }
    select, input[type="text"], button, textarea{
      font-size:15px;
      padding:10px 12px;
      border-radius:12px;
    }
    input[type="text"]{ width: min(260px, 70vw); }

    #mapWrap{ flex-direction: column; align-items: stretch; }
    #legend{ width:auto; max-width:none; position:relative; top:0; margin-bottom:10px; }

    .hint{ font-size:13px; line-height:1.55; }
    .menu{ min-width: min(92vw, 320px); }
  }

  /* åœ°åœ–æ’åº Modal */
  #sortModal{
    position:fixed;
    inset:0;
    background: rgba(0,0,0,.62);
    display:flex;
    align-items:center;
    justify-content:center;
    z-index:220;
  }
  #sortModal[hidden]{ display:none; }

  .sort-panel{
    width:min(92vw, 420px);
    background:#181818;
    border:1px solid rgba(255,255,255,.12);
    border-radius:14px;
    box-shadow:0 18px 50px rgba(0,0,0,.55);
    padding:14px;
  }

  .sort-head{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    margin-bottom:10px;
  }
  .sort-title{
    font-weight:750;
    font-size:14px;
    color: rgba(255,255,255,.92);
  }
  .sort-sub{
    font-size:12px;
    color: rgba(255,255,255,.62);
    margin-top:2px;
    line-height:1.35;
  }

  .sort-actions{ display:flex; gap:8px; }
  .sort-actions button{
    border:1px solid rgba(255,255,255,.14);
    border-radius:10px;
    padding:8px 10px;
    background:#1b1b1b;
    color:#fff;
    cursor:pointer;
  }

  #sortList, #spiritSortList{
    list-style:none;
    padding:0;
    margin:10px 0 0 0;
    max-height: min(56vh, 420px);
    overflow:auto;
  }

  #sortList li, #spiritSortList li{
    display:flex;
    align-items:center;
    gap:10px;
    padding:10px 10px;
    border:1px solid rgba(255,255,255,.14);
    border-radius:12px;
    background:#1f1f1f;
    margin-bottom:8px;
    cursor:grab;
    user-select:none;
  }

  #sortList li:active, #spiritSortList li:active{ cursor:grabbing; }
  #sortList li.dragging, #spiritSortList li.dragging{ opacity:.45; }

  .drag-handle{
    width:18px; height:18px;
    border-radius:6px;
    border:1px solid rgba(255,255,255,.12);
    display:inline-flex;
    align-items:center;
    justify-content:center;
    color: rgba(255,255,255,.65);
    font-size:12px;
    flex:0 0 auto;
  }

  .sort-name{
    flex:1 1 auto;
    overflow:hidden;
    text-overflow:ellipsis;
    white-space:nowrap;
    color: rgba(255,255,255,.9);
    font-size:13px;
  }

  /* è¦å‰‡ Dialog */
  .rule-btn{
    margin-top:10px;
    background: transparent;
    border: 1px solid rgba(255,255,255,.16);
    color: rgba(255,255,255,.92);
    padding: 10px 12px;
    border-radius: 12px;
    cursor: pointer;
  }
  .rule-btn:hover{ background: rgba(255,255,255,.06); }

  .rule-dialog{
    width: min(760px, 92vw);
    border: 1px solid rgba(255,255,255,.14);
    border-radius: 16px;
    padding: 0;
    background: #181818;
    color: #fff;
    box-shadow: 0 18px 60px rgba(0,0,0,.55);
  }
  .rule-dialog::backdrop{ background: rgba(0,0,0,.55); }

  .rule-head{
    display:flex;
    align-items:center;
    justify-content: space-between;
    padding: 12px;
    border-bottom: 1px solid rgba(255,255,255,.10);
  }
  .rule-title{ font-weight: 750; }
  .rule-close{
    background: transparent;
    border: 1px solid rgba(255,255,255,.14);
    border-radius: 10px;
    padding: 6px 10px;
    cursor: pointer;
  }

  .rule-body{
    padding: 12px;
    max-height: min(72vh, 640px);
    overflow: auto;
    display: grid;
    gap: 10px;
  }
  .rule-card{
    border: 1px solid rgba(255,255,255,.10);
    background: rgba(255,255,255,.04);
    border-radius: 14px;
    padding: 12px;
  }
  .rule-card h3{
    margin: 0 0 6px 0;
    font-size: 14px;
  }
  .rule-card p, .rule-card li{
    margin: 6px 0;
    color: rgba(255,255,255,.78);
  }

  /* è‡ªå®šç¾©æ¨¡å¼ */
  [data-custom]{ display:none; }
  body.custom [data-custom]{ display:unset; }
  body.custom .custom-inline{ display:inline-flex !important; }

  .custom-badge{
    border: 1px solid rgba(120,255,180,.35);
    background: rgba(120,255,180,.08);
  }

  .custom-only{ display:none !important; }
  body.custom .custom-only{ display:flex !important; }

  /* æŸ¥è©¢é­”éˆ Dialog */
  .spirit-dialog{
    width:min(920px, 94vw);
    border:1px solid rgba(255,255,255,.14);
    border-radius:16px;
    padding:0;
    background:#181818;
    color:#fff;
    box-shadow:0 18px 60px rgba(0,0,0,.55);
  }
  .spirit-dialog::backdrop{ background: rgba(0,0,0,.58); }

  .spirit-head{
    display:flex;
    align-items:center;
    justify-content:space-between;
    padding:12px;
    border-bottom:1px solid rgba(255,255,255,.10);
    gap:10px;
  }
  .spirit-title{
    font-weight:800;
    display:flex;
    align-items:center;
    gap:10px;
  }
  .spirit-sub{
    font-size:12px;
    color: rgba(255,255,255,.62);
    margin-top:2px;
    line-height:1.35;
  }

  .spirit-head-actions{
    display:flex;
    gap:8px;
    align-items:center;
  }

  .spirit-body{
    padding:12px;
    display:grid;
    gap:12px;
    max-height:min(76vh, 720px);
    overflow:auto;
  }

  .grid2{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap:12px;
  }
  @media (max-width: 920px){
    .grid2{ grid-template-columns: 1fr; }
  }

  .card{
    border:1px solid rgba(255,255,255,.10);
    background: rgba(255,255,255,.04);
    border-radius:14px;
    padding:12px;
  }
  .card h3{
    margin:0 0 8px 0;
    font-size:14px;
  }
  .muted{ color: rgba(255,255,255,.68); font-size:12px; line-height:1.5; }

  .list{
    display:grid;
    gap:6px;
    margin-top:10px;
  }
  .rowline{
    display:flex;
    align-items:center;
    gap:10px;
    padding:8px 8px;
    border-radius:12px;
    border:1px solid rgba(255,255,255,.10);
    background: rgba(0,0,0,.14);
  }
  .rowline:hover{ background: rgba(255,255,255,.06); }

  .chk{
    display:flex;
    align-items:center;
    gap:10px;
    flex:1 1 auto;
    min-width: 0;
  }
  .chk input{ transform: scale(1.1); }
  .name{
    overflow:hidden;
    text-overflow:ellipsis;
    white-space:nowrap;
    color: rgba(255,255,255,.92);
    font-size:13px;
  }
  .kbadge{
    display:inline-flex;
    align-items:center;
    gap:6px;
    padding:4px 8px;
    border-radius:999px;
    border:1px solid rgba(255,255,255,.14);
    background: rgba(0,0,0,.18);
    font-size:12px;
    color: rgba(255,255,255,.82);
    white-space:nowrap;
  }

  .toolbar{
    display:flex;
    gap:8px;
    flex-wrap:wrap;
    align-items:center;
  }
  .toolbar input[type="text"]{ width: min(320px, 70vw); }

  .spirit-foot{
    display:flex;
    gap:8px;
    justify-content:flex-end;
    padding:12px;
    border-top:1px solid rgba(255,255,255,.10);
  }

  /* è¨»è¨˜æ¨¡å¼æç¤º */
  #annotateBar{
    position: sticky;
    top: 68px;
    z-index: 11;
    margin: 8px 0 0 0;
    border:1px solid rgba(120,255,180,.22);
    background: rgba(120,255,180,.08);
    border-radius: 14px;
    padding: 10px 12px;
    display:none;
    gap:10px;
    align-items:flex-start;
  }
  #annotateBar.show{ display:flex; }
  .annotate-left{ flex:1 1 auto; min-width:0; }
  .annotate-title{
    font-weight:800;
    color: rgba(255,255,255,.92);
    margin-bottom:4px;
  }
  .annotate-desc{
    font-size:12px;
    color: rgba(255,255,255,.75);
    line-height:1.45;
  }
  .annotate-actions{
    display:flex;
    gap:8px;
    flex:0 0 auto;
    align-items:center;
  }
  .annotate-mini{
    margin-top:8px;
    display:flex;
    flex-wrap:wrap;
    gap:6px;
  }
  .assign-pill{
    display:inline-flex;
    align-items:center;
    gap:6px;
    padding:4px 8px;
    border-radius:999px;
    border:1px solid rgba(120,255,180,.26);
    background: rgba(120,255,180,.08);
    font-size:12px;
    color: rgba(255,255,255,.84);
  }

  /* é­”éˆæ’åº Modal */
  #spiritSortModal{
    position:fixed;
    inset:0;
    background: rgba(0,0,0,.62);
    display:flex;
    align-items:center;
    justify-content:center;
    z-index:230;
  }
  #spiritSortModal[hidden]{ display:none; }

  button:disabled{
    opacity:.45;
    cursor:not-allowed;
    filter: grayscale(.2);
  }

  /* å½¢æ…‹ Tabs */
  .variant-tabs{
    display:flex;
    gap:8px;
    flex-wrap:wrap;
    margin-top:8px;
  }
  .vtab{
    border:1px solid rgba(255,255,255,.14);
    background:#1b1b1b;
    color:#fff;
    border-radius:12px;
    padding:8px 10px;
    cursor:pointer;
    font-size:13px;
  }
  .vtab.active{
    border-color: rgba(130,200,255,.6);
    box-shadow: 0 0 0 2px rgba(130,200,255,.12) inset;
  }
</style>
</head>

<body>
<header>
  <h1>ğŸ“ é­”éˆæ¨™ç¤ºè¼”åŠ©å™¨</h1>

  <div class="row">
    <span class="badge">æ¨¡å¼ï¼š<b id="modeLabel">ä¸€èˆ¬</b></span>
    <span class="badge custom-badge custom-inline" data-custom>è‡ªå®šç¾©æ¨¡å¼ï¼š<b>ON</b></span>

    <label>åœ°åœ–ï¼š
      <select id="mapSelect"></select>
    </label>

    <label class="custom-inline" data-custom>åç¨±ï¼š
      <input id="mapName" type="text" placeholder="åœ°åœ–åç¨±ï¼ˆè‡ªå®šç¾©ï¼‰" />
    </label>

    <div class="menu-group">
      <div class="dropdown" data-dd>
        <button class="menu-btn" type="button" aria-expanded="false">ğŸ’¾ è³‡æ–™ â–¾</button>
        <div class="menu" role="menu">
          <button id="btnSortMaps" type="button">ğŸ”– èª¿æ•´åœ°åœ–é †åº</button>
          <hr>
          <button id="btnExport" type="button">â¬‡ï¸ åŒ¯å‡ºè³‡æ–™</button>
          <button id="btnImport" type="button">â¬†ï¸ å°å…¥è³‡æ–™</button>
          <hr>
          <button id="btnResetAllStates" type="button">ğŸ”„ å…¨éƒ¨é»ä½ç‹€æ…‹é‡ç½®ï¼ˆ#0ï¼‰</button>
          <hr>
          <button class="danger" id="btnClearAll" type="button">ğŸ§¹ æ¸…ç©ºæ‰€æœ‰è³‡æ–™ï¼ˆåˆå§‹åŒ–ï¼‰</button>
        </div>
      </div>

      <button id="btnOpenSpirits" type="button" class="primary">ğŸ” æŸ¥è©¢é­”éˆ</button>

      <button id="btnToggleCustom" type="button" class="primary">ğŸ§© è‡ªå®šç¾©æ¨¡å¼</button>

      <div class="dropdown" data-dd data-custom>
        <button class="menu-btn" type="button" aria-expanded="false">ğŸ› ï¸ è‡ªå®šç¾© â–¾</button>
        <div class="menu" role="menu">
          <button id="btnCustomToggleAddMarker" type="button">ğŸ“ æ–°å¢é»ä½</button>
          <button id="btnCustomToggleDeleteMarker" type="button">ğŸ—‘ï¸ åˆªé™¤é»ä½</button>
          <hr>
          <button id="btnDeleteMarkersCurrent" type="button">ğŸ§¹ æ¸…ç©ºæœ¬åœ°åœ–é»ä½</button>
          <button class="danger" id="btnDeleteAllMarkers" type="button">ğŸ’¥ åˆªé™¤æ‰€æœ‰é»ä½</button>
          <hr>
          <button id="btnAddMap" type="button">ğŸ–¼ï¸ æ–°å¢åœ°åœ–</button>
          <button class="danger" id="btnDeleteMap" type="button">ğŸ§¨ åˆªé™¤åœ°åœ–</button>
          <button id="btnReplaceMapImage" type="button">ğŸ” é‡æ–°ä¸Šå‚³æ­¤åœ°åœ–åœ–ç‰‡</button>
        </div>
      </div>
    </div>
  </div>

  <div id="annotateBar" aria-live="polite">
    <div class="annotate-left">
      <div class="annotate-title" id="annotateTitle">è«‹é»é¸è¦è¨»è¨˜çš„é»ä½</div>
      <div class="annotate-desc" id="annotateDesc"></div>
      <div class="annotate-mini" id="annotateMini"></div>
    </div>
    <div class="annotate-actions">
      <button id="btnAnnotateCancel" type="button" class="danger">å–æ¶ˆ</button>
      <button id="btnAnnotateDone" type="button" class="primary">å®Œæˆ</button>
    </div>
  </div>

  <div class="hint">
    <div class="hint-line">
      <span class="hint-strong">é»ä½åªéœ€é»æ“Šåˆ‡æ›ç‹€æ…‹ã€‚</span>
      <span class="hint-info">ï¼ˆæœ¬å·¥å…·è‡ªå‹•ä¿å­˜ï¼‰</span>
    </div>

    <div class="hint-line">
      <span class="hint-title">åˆ·æ–°æ•¸é‡</span>ï¼š
      æ·¨ç•Œå³¶ 8ï½œå†°æ¹– ä¸»åŸ 4 / éƒŠå¤– 10 / æ´çªŸ&Boss 3 - å…± 17ï½œä¸‹æ°´é“ 7ï½œå»¢ç¤¦ 7ï½œé¾èè¦å¡ 7ï½œç…™æ´¥æ¸¡ 25
    </div>

    <div class="hint-line hint-warning">
      é”æ•æ‰ä¸Šé™å¾Œï¼ŒåŒåœ°åœ–å…¶é¤˜é»ä½å¯ç•¥éã€‚
    </div>

    <button id="btnOpenRules" type="button" class="rule-btn">ğŸ“˜ é­”éˆåˆ·æ–°è¦å‰‡ï¼ˆé»é–‹æŸ¥çœ‹ï¼‰</button>
  </div>

  <dialog id="ruleDialog" class="rule-dialog">
    <div class="rule-head">
      <div class="rule-title">ğŸ“˜ é­”éˆåˆ·æ–°è¦å‰‡</div>
      <button type="button" class="rule-close" id="btnCloseRules">âœ•</button>
    </div>
    <div class="rule-body">
      <section class="rule-card">
        <h3>åˆ·æ–°é †åº</h3>
        <p>3 â†’ 6 â†’ 2 â†’ 5 â†’ 1 â†’ 4 â†’ 7ï¼ˆå¾ªç’°ï¼‰</p>
        <p>â€» ç¦®æ‹œä¸‰ã€å…­ã€äºŒã€äº”ã€ä¸€ã€å››ã€æ—¥</p>
      </section>
      <section class="rule-card">
        <h3>72 å°æ™‚é‡ç½®</h3>
        <p>ç„¡è«–æˆåŠŸæˆ–å¤±æ•—ï¼Œçš†ä»¥ã€Œåˆ·æ–°å¾Œ +72 å°æ™‚ã€é‡ç½®ï¼›é‡ç½®å¾Œå¯èƒ½å‡ºç¾åœ¨å…¶ä»–é»ä½ã€‚</p>
      </section>
      <section class="rule-card">
        <h3>é­”éˆå‡ºç¾è¦å‰‡ï¼ˆå°ç…§ï¼‰</h3>
        <ul>
          <li>ç¬¬ 1 å¤©ï¼šæˆåŠŸ â†’ ç¬¬ 2ã€3 å¤©ä¸é¡¯ç¤ºï¼›å¤±æ•— â†’ ç¬¬ 2ã€3 å¤©é¡¯ç¤º</li>
          <li>ç¬¬ 2 å¤©ï¼šæˆåŠŸ â†’ ç¬¬ 3 å¤©ä¸é¡¯ç¤ºï¼›å¤±æ•— â†’ ç¬¬ 3 å¤©é¡¯ç¤º</li>
          <li>ç¬¬ 3 å¤©ï¼šæˆåŠŸ / å¤±æ•— â†’ éé»ç­‰å¾…åˆ·æ–°</li>
        </ul>
      </section>
    </div>
  </dialog>

  <dialog id="spiritDialog" class="spirit-dialog">
    <div class="spirit-head">
      <div>
        <div class="spirit-title">ğŸ” æŸ¥è©¢é­”éˆ</div>
        <div class="spirit-sub" id="spiritSubText">
          å‹¾é¸åç¨±å¯åœ¨åœ°åœ–ä¸Šé«˜äº®ç¬¦åˆé»ä½ï¼Œå·¦å´è³‡è¨Šæ¬„æœƒé¡¯ç¤ºçµæœã€‚
        </div>
      </div>
      <div class="spirit-head-actions">
        <button type="button" class="rule-close" id="btnCloseSpirits">âœ•</button>
      </div>
    </div>

    <div class="spirit-body grid2">
      <section class="card">
        <h3>é­”éˆåç¨±</h3>

        <div class="toolbar">
          <input id="spiritSearch" type="text" placeholder="æœå°‹åç¨±â€¦" />
          <button id="btnSpiritsSelectAll" type="button">å…¨é¸</button>
          <button id="btnSpiritsClear" type="button" class="danger">æ¸…ç©º</button>
          <button id="btnOpenSpiritSort" type="button">ğŸ”– æ’åˆ—é †åº</button>
        </div>

        <div class="variant-tabs" id="variantTabs">
          <button type="button" class="vtab" data-vf="miracle">âœ¨ å¥‡è·¡</button>
          <button type="button" class="vtab" data-vf="keen">âš”ï¸ éŠ³æ„</button>
          <button type="button" class="vtab" data-vf="shine">ğŸ’ é–ƒäº®</button>
        </div>

        <div id="spiritList" class="list"></div>

        <div class="muted" style="margin-top:10px;">
          æç¤ºï¼šå¯å¤šé¸ï¼›æœƒæŠŠã€Œæ‰€æœ‰åœ°åœ–ã€ç¬¦åˆçš„é»ä½ä¸€èµ·çµ±è¨ˆã€‚<br>
          <b>æ³¨æ„ï¼š</b>æœ¬è¦–çª—å…§çš„å‹¾é¸/ç›®æ¨™åˆ‡æ›ï¼Œå¿…é ˆæŒ‰ã€Œå®Œæˆã€æ‰æœƒå¥—ç”¨ã€‚
        </div>

        <div class="toolbar custom-only">
          <button id="btnSpiritAdd" type="button" class="primary">ï¼‹ æ–°å¢é­”éˆ</button>
          <button id="btnStartAnnotate" type="button" class="primary">ğŸ§© é­”éˆé»ä½è¨»è¨˜</button>
          <span id="spiritPickBadge" class="kbadge" style="display:none;">ğŸ¯ ç›®æ¨™ï¼šâ€”</span>
        </div>

        <div class="muted custom-only" style="margin-top:8px;">
          ä½¿ç”¨æ–¹æ³•ï¼šå…ˆåœ¨å³å´ã€Œé­”éˆç®¡ç†ã€é¸ä¸€å€‹ã€Œè¨»è¨˜ç›®æ¨™ã€ï¼Œå†æŒ‰ã€Œé­”éˆé»ä½è¨»è¨˜ã€ã€‚<br>
          <b>å½¢æ…‹åˆ‡æ›</b>æœƒå½±éŸ¿ä½ æ­£åœ¨è¨»è¨˜/æŸ¥è©¢çš„æ˜¯å¥‡è·¡ã€éŠ³æ„æˆ–é–ƒäº®çš„é»ä½ã€‚
        </div>
      </section>

      <section class="card">
        <h3>è³‡è¨Šæ¬„</h3>
        <div id="spiritInfoBox" class="muted"></div>

        <div data-custom>
          <div class="panel-sep"></div>
          <h3>é­”éˆç®¡ç†</h3>
          <div class="muted" id="manageHintText">åœ¨æ­¤å¯æ”¹åã€åˆªé™¤ã€æŒ‡å®šã€Œè¨»è¨˜ç›®æ¨™ã€ã€‚</div>

          <div class="toolbar" style="margin-top:8px;">
            <button id="btnManageSelectAll" type="button">å…¨é¸</button>
            <button id="btnManageClear" type="button" class="danger">æ¸…ç©º</button>
            <button id="btnManageBulkDelete" type="button" class="danger">åˆªé™¤</button>
            <span id="manageSelectedBadge" class="kbadge">å·²é¸ï¼š0</span>
          </div>

          <div id="spiritManageList" class="list"></div>
        </div>
      </section>
    </div>

    <div class="spirit-foot">
      <button id="btnSpiritsDone" type="button" class="primary">å®Œæˆ</button>
    </div>
  </dialog>

  <div id="spiritSortModal" hidden aria-hidden="true">
    <div class="sort-panel" role="dialog" aria-modal="true" aria-label="èª¿æ•´é­”éˆé †åº">
      <div class="sort-head">
        <div>
          <div class="sort-title">ğŸ”– æ‹–æ›³èª¿æ•´é­”éˆåç¨±é †åº</div>
          <div class="sort-sub">æœƒå½±éŸ¿ã€ŒæŸ¥è©¢é­”éˆã€æ¸…å–®é †åºï¼›ä¸å½±éŸ¿ä»»ä½•é»ä½èˆ‡ç‹€æ…‹ã€‚</div>
        </div>
        <div class="sort-actions">
          <button id="btnSpiritSortCancel" type="button">å–æ¶ˆ</button>
          <button id="btnSpiritSortDone" type="button" class="primary">å®Œæˆ</button>
        </div>
      </div>
      <ul id="spiritSortList"></ul>
    </div>
  </div>
</header>

<main>
  <div id="mapWrap">
    <aside id="legend" aria-label="é»ä½ç‹€æ…‹èªªæ˜èˆ‡çµ±è¨ˆ"></aside>
    <div id="mapContainer">
      <img id="mapImg" alt="map" />
    </div>
  </div>

  <input id="fileMap" type="file" accept="image/*" style="display:none" />
  <input id="fileImport" type="file" accept="application/json,.json" style="display:none" />

  <div id="sortModal" hidden aria-hidden="true">
    <div class="sort-panel" role="dialog" aria-modal="true" aria-label="èª¿æ•´åœ°åœ–é †åº">
      <div class="sort-head">
        <div>
          <div class="sort-title">ğŸ”– æ‹–æ›³èª¿æ•´åœ°åœ–é †åº</div>
          <div class="sort-sub">æœƒå½±éŸ¿ã€Œåœ°åœ–ä¸‹æ‹‰ã€èˆ‡ã€Œå·¦å´çµ±è¨ˆã€çš„é †åºï¼Œä¸æœƒå½±éŸ¿ä»»ä½•é»ä½ã€‚</div>
        </div>
        <div class="sort-actions">
          <button id="btnSortCancel" type="button">å–æ¶ˆ</button>
          <button id="btnSortDone" type="button" class="primary">å®Œæˆ</button>
        </div>
      </div>
      <ul id="sortList"></ul>
    </div>
  </div>
</main>

<script>
/* =====================
   å®‰å…¨é™åˆ¶
===================== */
const IMPORT_MAX_BYTES = 3 * 1024 * 1024;
const IMPORT_MAX_MARKERS = 5000;
const ALLOW_EXPORT_BASE64_MAPS = false;

/* =====================
   è‡ªå®šç¾©æ¨¡å¼
===================== */
const CUSTOM_SESSION_KEY = "mapTaskTool_customEnabled_v1";
let customEnabled = (localStorage.getItem(CUSTOM_SESSION_KEY) === "1");

/* =====================
   é­”éˆå½¢æ…‹ï¼ˆå›ºå®šä¸‰ç¨®ï¼‰
===================== */
const SPIRIT_VARIANTS = [
  { key: "miracle", label: "å¥‡è·¡", emoji: "âœ¨" },
  { key: "keen",   label: "éŠ³æ„", emoji: "âš”ï¸" },
  { key: "shine",  label: "é–ƒäº®", emoji: "ğŸ’" },
];
const DEFAULT_VARIANT = "miracle";
function variantLabel(key){ return SPIRIT_VARIANTS.find(v => v.key === key)?.label || "å¥‡è·¡"; }
function variantEmoji(key){ return SPIRIT_VARIANTS.find(v => v.key === key)?.emoji || "âœ¨"; }
function tagKey(spiritId, variant){ return `${spiritId}::${variant}`; }
function parseTag(tag){
  const [id, v] = String(tag||"").split("::");
  if (!id) return null;
  return { spiritId: id, variant: v || DEFAULT_VARIANT };
}

/* =====================
   æŸ¥è©¢é­”éˆï¼šUI ç‹€æ…‹ï¼ˆå·²å¥—ç”¨ï¼‰
===================== */
const selectedSpiritTags = new Set(); // âœ… å·²å¥—ç”¨ï¼šSet<tag>
let activeSpiritPickTag = null;       // âœ… å·²å¥—ç”¨ï¼štag

/* é¢æ¿æš«å­˜ï¼ˆæŒ‰å®Œæˆæ‰å¥—ç”¨ï¼‰ */
let panelSelectedSpiritTags = new Set();
let panelActiveSpiritPickTag = null;
let panelVariantFilter = DEFAULT_VARIANT;

/* é­”éˆç®¡ç†ï¼šæ‰¹æ¬¡åˆªé™¤å‹¾é¸ï¼ˆé¢æ¿å…§ï¼‰ */
let panelManageDeleteIds = new Set();

/* è¨»è¨˜æ¨¡å¼ */
let annotateMode = false;
let annotateTag = null;

/* è‰ç¨¿åˆ¶ */
let panelSpiritsDraft = [];
let panelDeletedSpiritIds = new Set();

/* =====================
   ç‹€æ…‹
===================== */
const stateIcons = ["icons/state0.png","icons/state1.png","icons/state2.png","icons/state3.png"];
const stateLegend = ["é‚„æ²’çœ‹","æŠ“åˆ°äº†","æ²’é­”éˆ","å¤±æ•— / éœ€å†è©¦"];
const STORAGE_KEY = "mapTaskTool_v7";

/* =====================
   é è¨­è³‡æ–™
===================== */
function createDefaultData(){
  return {
    maps: [
      { id: uid(), name: "æ·¨ç•Œå³¶", src: "maps/map1.png" },
      { id: uid(), name: "å†°æ¹–åŸæ±å€", src: "maps/map2.png" },
      { id: uid(), name: "å†°æ¹–åŸä¸‹æ°´é“", src: "maps/map3.png" },
      { id: uid(), name: "æ ¼é›·å§†å»¢ç¤¦", src: "maps/map4.png" },
      { id: uid(), name: "é¾èè¦å¡", src: "maps/map5.png" },
      { id: uid(), name: "ç…™æ´¥æ¸¡", src: "maps/map6.png" },
    ],
    markers: [],
    spirits: [
      { id: uid(), name: "ç¤ºç¯„é­”éˆA" },
      { id: uid(), name: "ç¤ºç¯„é­”éˆB" },
    ],
    currentMapId: null
  };
}

let data = createDefaultData();
let mode = "normal";

/* =====================
   DOM
===================== */
const mapSelect = document.getElementById("mapSelect");
const mapNameInput = document.getElementById("mapName");
const mapImg = document.getElementById("mapImg");
const mapContainer = document.getElementById("mapContainer");
const modeLabel = document.getElementById("modeLabel");
const legendEl = document.getElementById("legend");

const btnToggleCustom = document.getElementById("btnToggleCustom");
const btnCustomToggleAddMarker = document.getElementById("btnCustomToggleAddMarker");
const btnCustomToggleDeleteMarker = document.getElementById("btnCustomToggleDeleteMarker");
const btnAddMap = document.getElementById("btnAddMap");
const btnDeleteMap = document.getElementById("btnDeleteMap");
const btnReplaceMapImage = document.getElementById("btnReplaceMapImage");
const fileMap = document.getElementById("fileMap");
const btnDeleteMarkersCurrent = document.getElementById("btnDeleteMarkersCurrent");
const btnDeleteAllMarkers = document.getElementById("btnDeleteAllMarkers");

const btnSortMaps = document.getElementById("btnSortMaps");
const sortModal = document.getElementById("sortModal");
const sortList = document.getElementById("sortList");
const btnSortDone = document.getElementById("btnSortDone");
const btnSortCancel = document.getElementById("btnSortCancel");

const btnExport = document.getElementById("btnExport");
const btnImport = document.getElementById("btnImport");
const fileImport = document.getElementById("fileImport");
const btnClearAll = document.getElementById("btnClearAll");
const btnResetAllStates = document.getElementById("btnResetAllStates");

/* æŸ¥è©¢é­”éˆ */
const btnOpenSpirits = document.getElementById("btnOpenSpirits");
const spiritDialog = document.getElementById("spiritDialog");
const btnCloseSpirits = document.getElementById("btnCloseSpirits");
const btnSpiritsDone = document.getElementById("btnSpiritsDone");
const spiritSubText = document.getElementById("spiritSubText");
const spiritSearch = document.getElementById("spiritSearch");
const spiritList = document.getElementById("spiritList");
const spiritInfoBox = document.getElementById("spiritInfoBox");
const spiritManageList = document.getElementById("spiritManageList");
const manageHintText = document.getElementById("manageHintText");
const btnSpiritsSelectAll = document.getElementById("btnSpiritsSelectAll");
const btnSpiritsClear = document.getElementById("btnSpiritsClear");
const btnSpiritAdd = document.getElementById("btnSpiritAdd");
const btnStartAnnotate = document.getElementById("btnStartAnnotate");
const spiritPickBadge = document.getElementById("spiritPickBadge");

/* é­”éˆç®¡ç†ï¼šæ‰¹æ¬¡å·¥å…·åˆ— */
const btnManageSelectAll = document.getElementById("btnManageSelectAll");
const btnManageClear = document.getElementById("btnManageClear");
const btnManageBulkDelete = document.getElementById("btnManageBulkDelete");
const manageSelectedBadge = document.getElementById("manageSelectedBadge");

/* è¨»è¨˜ bar */
const annotateBar = document.getElementById("annotateBar");
const annotateTitle = document.getElementById("annotateTitle");
const annotateDesc = document.getElementById("annotateDesc");
const annotateMini = document.getElementById("annotateMini");
const btnAnnotateCancel = document.getElementById("btnAnnotateCancel");
const btnAnnotateDone = document.getElementById("btnAnnotateDone");

/* é­”éˆæ’åº */
const btnOpenSpiritSort = document.getElementById("btnOpenSpiritSort");
const spiritSortModal = document.getElementById("spiritSortModal");
const spiritSortList = document.getElementById("spiritSortList");
const btnSpiritSortDone = document.getElementById("btnSpiritSortDone");
const btnSpiritSortCancel = document.getElementById("btnSpiritSortCancel");

/* è¦å‰‡ */
const btnOpenRules = document.getElementById("btnOpenRules");
const ruleDialog = document.getElementById("ruleDialog");
const btnCloseRules = document.getElementById("btnCloseRules");

/* =====================
   åˆå§‹åŒ–
===================== */
applyCustomUI();
load();
repairDataShapeAndMigrate();

if (!data.currentMapId && data.maps.length) data.currentMapId = data.maps[0].id;
renderMapSelect();
syncCurrentMapUI();

syncPanelFromApplied();
render();

/* =====================
   è¦å‰‡ Dialog
===================== */
btnOpenRules.addEventListener("click", ()=> ruleDialog.showModal());
btnCloseRules.addEventListener("click", ()=> ruleDialog.close());
ruleDialog.addEventListener("click", (e) => {
  const r = ruleDialog.getBoundingClientRect();
  const inside = e.clientX>=r.left && e.clientX<=r.right && e.clientY>=r.top && e.clientY<=r.bottom;
  if (!inside) ruleDialog.close();
});

/* =====================
   è‡ªå®šç¾©æ¨¡å¼åˆ‡æ›
===================== */
btnToggleCustom.addEventListener("click", () => {
  customEnabled = !customEnabled;
  if (customEnabled) localStorage.setItem(CUSTOM_SESSION_KEY, "1");
  else {
    localStorage.removeItem(CUSTOM_SESSION_KEY);
    setMode("normal");
    stopAnnotateMode();
  }
  applyCustomUI();
  if (spiritDialog.open) renderSpiritDialog();
  render();
});

function applyCustomUI(){
  document.body.classList.toggle("custom", !!customEnabled);
  mapNameInput.disabled = !customEnabled;

  btnToggleCustom.classList.toggle("active", !!customEnabled);
  btnToggleCustom.textContent = customEnabled ? "ğŸ§© è‡ªå®šç¾©æ¨¡å¼ï¼šON" : "ğŸ§© è‡ªå®šç¾©æ¨¡å¼ï¼šOFF";

  spiritSubText.textContent = customEnabled
    ? "å‹¾é¸åç¨±å¯é«˜äº®ç¬¦åˆé»ä½ï¼›è¦è¨»è¨˜é»ä½è«‹å…ˆåœ¨å³å´é¸è¨»è¨˜ç›®æ¨™å†æŒ‰ã€Œé­”éˆé»ä½è¨»è¨˜ã€ã€‚"
    : "å‹¾é¸åç¨±å¯åœ¨åœ°åœ–ä¸Šé«˜äº®ç¬¦åˆé»ä½ï¼Œå·¦å´è³‡è¨Šæ¬„æœƒé¡¯ç¤ºçµæœã€‚ï¼ˆä¸æƒ³è‡ªå®šç¾©ä¹Ÿèƒ½ç›´æ¥ç”¨ï¼‰";
}

/* =====================
   æŸ¥è©¢é­”éˆ Dialogï¼ˆå®Œæˆæ‰å¥—ç”¨ï¼‰
===================== */
btnOpenSpirits.addEventListener("click", () => {
  syncPanelFromApplied();
  renderSpiritDialog();
  spiritDialog.showModal();
});

btnSpiritsDone.addEventListener("click", () => {
  applyPanelToApplied();
  spiritDialog.close();
  render();
});

btnCloseSpirits.addEventListener("click", () => attemptCloseSpiritDialog());

document.addEventListener("keydown", (e) => {
  if (e.key === "Escape" && spiritDialog.open){
    e.preventDefault();
    attemptCloseSpiritDialog();
  }
});

spiritSearch.addEventListener("input", () => renderSpiritDialog());

/* =====================
   âœ… æŸ¥è©¢é­”éˆï¼šä¾æœå°‹ + è‰ç¨¿
===================== */
function getFilteredSpirits(){
  const kw = (spiritSearch?.value || "").trim().toLowerCase();
  let list = panelSpiritsDraft.slice();
  if (kw){
    list = list.filter(s => (s.name || "").toLowerCase().includes(kw));
  }
  return list;
}

btnSpiritsSelectAll.addEventListener("click", () => {
  getFilteredSpirits().forEach(s => panelSelectedSpiritTags.add(tagKey(s.id, panelVariantFilter)));
  renderSpiritDialog();
});

btnSpiritsClear.addEventListener("click", () => {
  panelSelectedSpiritTags = new Set(Array.from(panelSelectedSpiritTags).filter(t => parseTag(t)?.variant !== panelVariantFilter));
  renderSpiritDialog();
});

function syncPanelFromApplied(){
  panelSelectedSpiritTags = new Set(Array.from(selectedSpiritTags));
  panelActiveSpiritPickTag = activeSpiritPickTag;

  panelSpiritsDraft = (data.spirits || []).map(s => ({
    id: s.id,
    name: s.name
  }));

  panelDeletedSpiritIds = new Set();
  panelManageDeleteIds = new Set();

  if (!panelVariantFilter) panelVariantFilter = DEFAULT_VARIANT;
}

function applyPanelToApplied(){
  const draftIds = new Set(panelSpiritsDraft.map(s => s.id));

  const deleted = new Set(panelDeletedSpiritIds);
  for (const s of (data.spirits || [])){
    if (!draftIds.has(s.id)) deleted.add(s.id);
  }

  data.spirits = panelSpiritsDraft.map(s => ({
    id: s.id,
    name: (s.name || "").trim() || "æœªå‘½åé­”éˆ",
  }));

  if (deleted.size > 0){
    data.markers.forEach(mk => {
      mk.spiritTags = (mk.spiritTags || []).filter(tag => {
        const p = parseTag(tag);
        return p && !deleted.has(p.spiritId);
      });
    });
  }

  selectedSpiritTags.clear();
  for (const t of panelSelectedSpiritTags) selectedSpiritTags.add(t);

  activeSpiritPickTag = panelActiveSpiritPickTag;

  if (activeSpiritPickTag){
    const p = parseTag(activeSpiritPickTag);
    if (!p || deleted.has(p.spiritId)) activeSpiritPickTag = null;
  }

  if (annotateTag){
    const p = parseTag(annotateTag);
    if (!p || deleted.has(p.spiritId)) stopAnnotateMode();
  }

  save();
  updateAnnotateButtonState();
  renderLegendAndStats();
}

function panelChanged(){
  const a = Array.from(selectedSpiritTags).sort().join("|");
  const b = Array.from(panelSelectedSpiritTags).sort().join("|");
  if (a !== b) return true;

  if ((activeSpiritPickTag || "") !== (panelActiveSpiritPickTag || "")) return true;

  const base = (data.spirits || []).map(s => `${s.id}::${s.name||""}`).sort().join("|");
  const draft = (panelSpiritsDraft || []).map(s => `${s.id}::${s.name||""}`).sort().join("|");
  if (base !== draft) return true;

  if (panelDeletedSpiritIds && panelDeletedSpiritIds.size > 0) return true;

  return false;
}

function attemptCloseSpiritDialog(){
  if (!panelChanged()){
    spiritDialog.close();
    return;
  }
  const ok = confirm("âš ï¸ ä½ åœ¨ã€ŒæŸ¥è©¢é­”éˆã€é¢æ¿çš„æ“ä½œå°šæœªæŒ‰ã€Œå®Œæˆã€è¨˜éŒ„ã€‚\n\næŒ‰ã€Œç¢ºå®šã€æœƒæ”¾æ£„æœ¬æ¬¡è®Šæ›´ä¸¦é—œé–‰è¦–çª—ã€‚\næŒ‰ã€Œå–æ¶ˆã€è¿”å›ç¹¼çºŒæ“ä½œã€‚");
  if (!ok) return;

  syncPanelFromApplied();
  spiritDialog.close();
}

/* =====================
   æ–°å¢é­”éˆï¼ˆåªæ–°å¢ä¸€éš»ï¼‰
===================== */
btnSpiritAdd?.addEventListener("click", () => {
  if (!customEnabled) return;

  const name = prompt("è¼¸å…¥é­”éˆåç¨±ï¼š", `æ–°é­”éˆ ${panelSpiritsDraft.length + 1}`);
  if (name === null) return;

  const nm = name.trim() || `æ–°é­”éˆ ${panelSpiritsDraft.length + 1}`;
  const s = { id: uid(), name: nm };
  panelSpiritsDraft.push(s);

  renderSpiritDialog();
});

/* =====================
   è¨»è¨˜æŒ‰éˆ•ç‹€æ…‹
===================== */
function updateAnnotateButtonState(){
  if (!btnStartAnnotate) return;

  btnStartAnnotate.textContent = "ğŸ§© é­”éˆé»ä½è¨»è¨˜";

  if (spiritPickBadge) spiritPickBadge.style.display = (customEnabled ? "inline-flex" : "none");

  if (annotateMode){
    btnStartAnnotate.disabled = true;
    btnStartAnnotate.title = "ç›®å‰æ­£åœ¨è¨»è¨˜æ¨¡å¼ä¸­ã€‚";
    if (spiritPickBadge){
      const nm = displayNameFromTag(annotateTag) || "æœªå‘½åé­”éˆ";
      spiritPickBadge.textContent = `ğŸ¯ ç›®æ¨™ï¼š${nm}`;
    }
    return;
  }

  if (!customEnabled){
    btnStartAnnotate.disabled = true;
    btnStartAnnotate.title = "è‡ªå®šç¾©æ¨¡å¼ ON æ‰èƒ½ä½¿ç”¨ã€‚";
    if (spiritPickBadge){
      spiritPickBadge.textContent = "ğŸ¯ ç›®æ¨™ï¼šâ€”";
      spiritPickBadge.style.display = "none";
    }
    return;
  }

  const target = spiritDialog?.open ? panelActiveSpiritPickTag : activeSpiritPickTag;

  if (!target){
    btnStartAnnotate.disabled = true;
    btnStartAnnotate.title = "è«‹å…ˆåœ¨å³å´ã€Œé­”éˆç®¡ç†ã€é¸ä¸€å€‹ã€è¨»è¨˜ç›®æ¨™ã€ã€‚";
    if (spiritPickBadge){
      spiritPickBadge.textContent = "ğŸ¯ ç›®æ¨™ï¼šâ€”";
      spiritPickBadge.style.display = "inline-flex";
    }
    return;
  }

  const name = displayNameFromTag(target) || "æœªå‘½åé­”éˆ";
  btnStartAnnotate.disabled = false;
  btnStartAnnotate.title = `é–‹å§‹è¨»è¨˜ï¼šã€Œ${name}ã€`;
  if (spiritPickBadge){
    spiritPickBadge.textContent = `ğŸ¯ ç›®æ¨™ï¼š${name}`;
    spiritPickBadge.style.display = "inline-flex";
  }
}

btnStartAnnotate?.addEventListener("click", () => {
  if (!customEnabled) return;

  const target = spiritDialog?.open ? panelActiveSpiritPickTag : activeSpiritPickTag;
  if (!target){
    alert("è«‹å…ˆåœ¨å³å´ã€Œé­”éˆç®¡ç†ã€é¸ä¸€å€‹ã€è¨»è¨˜ç›®æ¨™ã€ã€‚");
    return;
  }

  activeSpiritPickTag = target;
  panelActiveSpiritPickTag = target;

  if (mode !== "normal") setMode("normal");
  if (spiritDialog.open) spiritDialog.close();
  startAnnotateMode(target);
});

/* =====================
   è¨»è¨˜ bar
===================== */
btnAnnotateCancel.addEventListener("click", () => { stopAnnotateMode(); render(); });
btnAnnotateDone.addEventListener("click", () => {
  const name = displayNameFromTag(annotateTag) || "æœªå‘½åé­”éˆ";
  stopAnnotateMode();
  save();
  render();
  alert(`âœ… è¨»è¨˜æˆåŠŸï¼š${name}`);
});

/* =====================
   é­”éˆæ’åº
===================== */
let reopenSpiritDialogAfterSort = false;

btnOpenSpiritSort.addEventListener("click", () => {
  reopenSpiritDialogAfterSort = !!spiritDialog.open;
  if (spiritDialog.open) spiritDialog.close();
  openSpiritSortModal();
});

btnSpiritSortCancel.addEventListener("click", () => finishSpiritSort(false));
spiritSortModal.addEventListener("click", (e) => { if (e.target === spiritSortModal) finishSpiritSort(false); });
document.addEventListener("keydown", (e) => { if (e.key === "Escape" && !spiritSortModal.hidden) finishSpiritSort(false); });
btnSpiritSortDone.addEventListener("click", () => finishSpiritSort(true));

function finishSpiritSort(apply){
  if (apply){
    const newOrder = Array.from(spiritSortList.children).map(li => li.dataset.id);
    data.spirits.sort((a,b) => newOrder.indexOf(a.id) - newOrder.indexOf(b.id));
    save();
    renderLegendAndStats();
  }
  closeSpiritSortModal();

  if (reopenSpiritDialogAfterSort){
    syncPanelFromApplied();
    renderSpiritDialog();
    spiritDialog.showModal();
  }
  reopenSpiritDialogAfterSort = false;
}

function openSpiritSortModal(){
  spiritSortList.innerHTML = "";
  data.spirits.forEach(sp => {
    const li = document.createElement("li");
    li.draggable = true;
    li.dataset.id = sp.id;
    li.innerHTML = `
      <span class="drag-handle">â‰¡</span>
      <span class="sort-name">${escapeHtml(sp.name || "æœªå‘½åé­”éˆ")}</span>
    `;
    spiritSortList.appendChild(li);
  });

  spiritSortModal.hidden = false;
  spiritSortModal.setAttribute("aria-hidden","false");
  initDragSort(spiritSortList);
}

function closeSpiritSortModal(){
  spiritSortModal.hidden = true;
  spiritSortModal.setAttribute("aria-hidden","true");
  spiritSortList.innerHTML = "";
}

/* =====================
   åˆ‡åœ°åœ–
===================== */
mapSelect.addEventListener("change", () => {
  data.currentMapId = mapSelect.value;
  setMode("normal");
  syncCurrentMapUI();
  save();
  render();
});

/* åœ°åœ–æ”¹å */
mapNameInput.addEventListener("input", () => {
  if (!customEnabled) return;
  const m = getCurrentMap();
  if (!m) return;
  m.name = mapNameInput.value.trim() || "æœªå‘½ååœ°åœ–";
  renderMapSelect(true);
  save();
  renderLegendAndStats();
});

/* è‡ªå®šç¾©æ–°å¢/åˆªé™¤é»ä½æ¨¡å¼ */
btnCustomToggleAddMarker?.addEventListener("click", () => {
  if (!customEnabled) return;
  if (annotateMode) stopAnnotateMode();
  setMode(mode === "addMarker" ? "normal" : "addMarker");
});
btnCustomToggleDeleteMarker?.addEventListener("click", () => {
  if (!customEnabled) return;
  if (annotateMode) stopAnnotateMode();
  setMode(mode === "deleteMarker" ? "normal" : "deleteMarker");
});

/* é»åœ°åœ–æ–°å¢é»ä½ */
mapContainer.addEventListener("click", (e) => {
  const m = getCurrentMap();
  if (!m) return;
  if (!(customEnabled && mode === "addMarker")) return;

  const rect = mapContainer.getBoundingClientRect();
  const x = (e.clientX - rect.left) / rect.width;
  const y = (e.clientY - rect.top) / rect.height;

  data.markers.push({
    id: uid(), mapId: m.id, x: clamp01(x), y: clamp01(y),
    state: 0, createdAt: Date.now(),
    spiritTags: []
  });
  save();
  render();
});

/* å…¨éƒ¨ç‹€æ…‹é‡ç½® */
btnResetAllStates.addEventListener("click", () => {
  if (!confirm("ç¢ºå®šè¦æŠŠã€æ‰€æœ‰åœ°åœ–ã€‘çš„ã€æ‰€æœ‰é»ä½ã€‘éƒ½é‡ç½®æˆç‹€æ…‹ 0ï¼Ÿ")) return;
  data.markers.forEach(m => m.state = 0);
  save();
  render();
});

/* åŒ¯å‡º */
btnExport.addEventListener("click", () => {
  const lite = buildExportLiteData();
  const payload = { exportedAt: new Date().toISOString(), version: 7, data: lite };
  const json = JSON.stringify(payload, null, 2);
  const blob = new Blob([json], { type: "application/json" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = `map-task-data-lite-${formatDateForFile(new Date())}.json`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(() => URL.revokeObjectURL(a.href), 1000);
});

/* å°å…¥ */
btnImport.addEventListener("click", () => { fileImport.value=""; fileImport.click(); });
fileImport.addEventListener("change", async () => {
  const file = fileImport.files?.[0];
  if (!file) return;

  if (file.size > IMPORT_MAX_BYTES) {
    alert(`âŒ å°å…¥å¤±æ•—ï¼šæª”æ¡ˆå¤ªå¤§ï¼ˆ${formatBytes(file.size)}ï¼‰ã€‚\nä¸Šé™ç‚º ${formatBytes(IMPORT_MAX_BYTES)}ã€‚`);
    return;
  }

  try {
    const text = await file.text();
    const parsed = JSON.parse(text);
    const incoming = parsed?.data ? parsed.data : parsed;

    const incomingMarkers = Array.isArray(incoming?.markers) ? incoming.markers.length : 0;
    if (incomingMarkers > IMPORT_MAX_MARKERS) {
      alert(`âŒ å°å…¥å¤±æ•—ï¼šé»ä½æ•¸é‡éå¤šï¼ˆ${incomingMarkers}ï¼‰ã€‚\nä¸Šé™ç‚º ${IMPORT_MAX_MARKERS}ã€‚`);
      return;
    }

    assertValidData(incoming);

    const ok = confirm("å°å…¥æœƒã€è¦†è“‹ã€‘ä½ ç›®å‰çš„æ‰€æœ‰åœ°åœ–/é»ä½/ç‹€æ…‹/é­”éˆå°æ‡‰ã€‚\nå»ºè­°å…ˆåŒ¯å‡ºå‚™ä»½å†å°å…¥ã€‚\n\nç¢ºå®šè¦å°å…¥å—ï¼Ÿ");
    if (!ok) return;

    data = incoming;
    repairDataShapeAndMigrate();

    if (!data.currentMapId || !data.maps.some(m => m.id === data.currentMapId)) {
      data.currentMapId = data.maps[0]?.id ?? null;
    }

    selectedSpiritTags.clear();
    activeSpiritPickTag = null;
    syncPanelFromApplied();

    stopAnnotateMode();
    setMode("normal");
    renderMapSelect();
    syncCurrentMapUI();
    save();
    render();
    alert("âœ… å°å…¥å®Œæˆï¼");
  } catch (err) {
    console.error(err);
    alert("âŒ å°å…¥å¤±æ•—ï¼šJSON æ ¼å¼ä¸æ­£ç¢ºæˆ–è³‡æ–™å…§å®¹ä¸ç¬¦åˆå·¥å…·æ ¼å¼ã€‚");
  }
});

/* æ¸…ç©º */
btnClearAll.addEventListener("click", () => {
  const ok = confirm("âš ï¸ æ¸…ç©ºæ‰€æœ‰è³‡æ–™æœƒåˆªé™¤ localStorage è¨˜éŒ„ä¸¦å›åˆ°åˆå§‹ç‹€æ…‹ã€‚\nå»ºè­°å…ˆåŒ¯å‡ºå‚™ä»½ã€‚\n\nç¢ºå®šè¦æ¸…ç©ºå—ï¼Ÿ");
  if (!ok) return;

  localStorage.removeItem(STORAGE_KEY);
  data = createDefaultData();
  data.currentMapId = data.maps[0]?.id ?? null;

  selectedSpiritTags.clear();
  activeSpiritPickTag = null;
  syncPanelFromApplied();

  stopAnnotateMode();

  setMode("normal");
  renderMapSelect();
  syncCurrentMapUI();
  render();
  alert("âœ… å·²æ¸…ç©ºå®Œæˆï¼ˆå›åˆ°åˆå§‹ç‹€æ…‹ï¼‰");
});

/* åœ°åœ–æ’åº modal */
btnSortMaps.addEventListener("click", () => openSortModal());
btnSortCancel.addEventListener("click", closeSortModal);
sortModal.addEventListener("click", (e) => { if (e.target === sortModal) closeSortModal(); });
btnSortDone.addEventListener("click", () => {
  const newOrder = Array.from(sortList.children).map(li => li.dataset.id);
  data.maps.sort((a,b) => newOrder.indexOf(a.id) - newOrder.indexOf(b.id));
  save();
  renderMapSelect(true);
  renderLegendAndStats();
  closeSortModal();
});
function openSortModal(){
  sortList.innerHTML = "";
  data.maps.forEach((mp) => {
    const li = document.createElement("li");
    li.draggable = true;
    li.dataset.id = mp.id;
    li.innerHTML = `<span class="drag-handle">â‰¡</span><span class="sort-name">${escapeHtml(mp.name||"æœªå‘½ååœ°åœ–")}</span>`;
    sortList.appendChild(li);
  });
  sortModal.hidden = false;
  sortModal.setAttribute("aria-hidden","false");
  initDragSort(sortList);
}
function closeSortModal(){
  sortModal.hidden = true;
  sortModal.setAttribute("aria-hidden","true");
  sortList.innerHTML = "";
}

/* =====================
   âœ… è‡ªå®šç¾©åŠŸèƒ½ï¼šæ¸…ç©º/åˆªé™¤é»ä½ã€æ–°å¢/åˆªé™¤åœ°åœ–ã€æ›¿æ›åœ°åœ–åœ–
===================== */
btnDeleteMarkersCurrent?.addEventListener("click", () => {
  if (!customEnabled) return;
  const m = getCurrentMap();
  if (!m) return alert("ç›®å‰æ²’æœ‰å¯æ“ä½œçš„åœ°åœ–ã€‚");

  const ok = confirm(`ç¢ºå®šè¦æ¸…ç©ºã€Œ${m.name}ã€çš„æ‰€æœ‰é»ä½ï¼Ÿï¼ˆåƒ…æ­¤åœ°åœ–ï¼‰`);
  if (!ok) return;

  if (annotateMode) stopAnnotateMode();

  data.markers = data.markers.filter(x => x.mapId !== m.id);
  save();
  render();
});

btnDeleteAllMarkers?.addEventListener("click", () => {
  if (!customEnabled) return;

  const ok = confirm("âš ï¸ ç¢ºå®šè¦åˆªé™¤ã€æ‰€æœ‰åœ°åœ–ã€‘çš„ã€æ‰€æœ‰é»ä½ã€‘ï¼Ÿ\nï¼ˆåœ°åœ–ä»ä¿ç•™ï¼Œä½†é»ä½å…¨éƒ¨æ¸…ç©ºï¼‰");
  if (!ok) return;

  if (annotateMode) stopAnnotateMode();

  data.markers = [];
  save();
  render();
});

btnAddMap?.addEventListener("click", () => {
  if (!customEnabled) return;
  fileMap.value = "";
  fileMap.dataset.mode = "addMap";
  fileMap.click();
});

btnDeleteMap?.addEventListener("click", () => {
  if (!customEnabled) return;

  const m = getCurrentMap();
  if (!m) return alert("ç›®å‰æ²’æœ‰å¯åˆªé™¤çš„åœ°åœ–ã€‚");

  const ok = confirm(`âš ï¸ ç¢ºå®šè¦åˆªé™¤åœ°åœ–ã€Œ${m.name}ã€ï¼Ÿ\næ­¤åœ°åœ–çš„é»ä½ä¹Ÿæœƒä¸€ä½µåˆªé™¤ã€‚`);
  if (!ok) return;

  if (annotateMode) stopAnnotateMode();

  data.maps = data.maps.filter(x => x.id !== m.id);
  data.markers = data.markers.filter(x => x.mapId !== m.id);
  data.currentMapId = data.maps[0]?.id ?? null;

  save();
  renderMapSelect();
  syncCurrentMapUI();
  render();
});

btnReplaceMapImage?.addEventListener("click", () => {
  if (!customEnabled) return;

  const m = getCurrentMap();
  if (!m) return alert("ç›®å‰æ²’æœ‰å¯æ“ä½œçš„åœ°åœ–ã€‚");

  fileMap.value = "";
  fileMap.dataset.mode = "replaceMap";
  fileMap.dataset.mapId = m.id;
  fileMap.click();
});

fileMap?.addEventListener("change", async () => {
  if (!customEnabled) return;

  const file = fileMap.files?.[0];
  if (!file) return;

  const toDataURL = (f) => new Promise((resolve, reject) => {
    const r = new FileReader();
    r.onload = () => resolve(r.result);
    r.onerror = reject;
    r.readAsDataURL(f);
  });

  try {
    const dataUrl = await toDataURL(file);
    const m = fileMap.dataset.mode;

    if (m === "addMap") {
      const name = prompt("æ–°åœ°åœ–åç¨±ï¼š", file.name.replace(/\.[^.]+$/, "")) || "æœªå‘½ååœ°åœ–";
      const newMap = { id: uid(), name: name.trim() || "æœªå‘½ååœ°åœ–", src: dataUrl };
      data.maps.push(newMap);
      data.currentMapId = newMap.id;

      save();
      renderMapSelect();
      syncCurrentMapUI();
      render();
      return;
    }

    if (m === "replaceMap") {
      const mapId = fileMap.dataset.mapId;
      const mp = data.maps.find(x => x.id === mapId);
      if (!mp) return alert("æ‰¾ä¸åˆ°è¦æ›¿æ›çš„åœ°åœ–ã€‚");

      mp.src = dataUrl;
      mp.needsMapUpload = false;

      save();
      render();
      return;
    }
  } catch (err) {
    console.error(err);
    alert("ä¸Šå‚³å¤±æ•—ï¼šåœ–ç‰‡è®€å–éŒ¯èª¤æˆ–æ ¼å¼ä¸æ”¯æ´ã€‚");
  } finally {
    fileMap.dataset.mode = "";
    fileMap.dataset.mapId = "";
  }
});

/* =====================
   Renderï¼ˆåœ°åœ– + é»ä½ï¼‰
===================== */
function render(){
  renderLegendAndStats();

  const m = getCurrentMap();
  mapImg.src = m?.src || "";

  document.querySelectorAll(".marker").forEach(el => el.remove());
  if (!m) return;

  const currentMarkers = getMarkersInMap(m.id);

  currentMarkers.forEach((mm, idx) => {
    const wrap = document.createElement("div");
    wrap.className = "marker";
    wrap.style.left = (mm.x * 100) + "%";
    wrap.style.top  = (mm.y * 100) + "%";
    wrap.dataset.mid = mm.id;

    const ico = document.createElement("img");
    ico.className = "marker-ico";
    ico.src = stateIcons[mm.state] || stateIcons[0];

    const hit = document.createElement("button");
    hit.type = "button";
    hit.className = "marker-hit";
    hit.setAttribute("aria-label", "marker");

    // âœ… é«˜äº®ï¼šç”¨ã€Œå·²å¥—ç”¨ã€tag
    if (isMarkerMatchedBySelected(mm)) wrap.classList.add("hl");

    // âœ…ã€å„ªåŒ–ã€‘è¨»è¨˜æ¨¡å¼é€²å…¥å¾Œï¼šå·²è¨»è¨˜çš„é»ä½ç«‹å³é¡¯ç¤ºã€Œé«˜å…‰ã€+ã€Œassignã€
    // é€™æ¨£ä½¿ç”¨è€…ä¸å¿…å…ˆé»ä»»ä½•é»ä½ï¼Œå°±èƒ½ä¸€çœ¼çœ‹å‡ºå“ªäº›å·²è¨»è¨˜
    const hasAnnot = (annotateMode && annotateTag && (mm.spiritTags || []).includes(annotateTag));
    if (hasAnnot){
      wrap.classList.add("assign");
      wrap.classList.add("hl"); // âœ… ç”¨åŒä¸€å¥—é«˜å…‰è¦–è¦ºï¼Œç¬¦åˆä½ èªªçš„ã€Œç”¨é«˜å…‰åˆ¤æ–·ã€
    } else if (annotateMode && annotateTag && (mm.spiritTags || []).includes(annotateTag)) {
      //ï¼ˆä¿ç•™èˆŠé‚è¼¯å‚™æ´ï¼Œå¯¦éš›ä¸Šæœƒè¢«ä¸Šé¢ hasAnnot è¦†è“‹ï¼‰
      wrap.classList.add("assign");
    }

    const num = idx + 1;
    const spiritLine = getSpiritNamesByMarker(mm).length ? `\né­”éˆï¼š${getSpiritNamesByMarker(mm).join("ã€")}` : "";

    wrap.title = (customEnabled && mode === "deleteMarker")
      ? `#${num}ï½œé»ä¸€ä¸‹åˆªé™¤é€™å€‹é»ä½${spiritLine}`
      : (annotateMode && annotateTag)
        ? `#${num}ï½œï¼ˆè¨»è¨˜æ¨¡å¼ï¼‰é»ä¸€ä¸‹åˆ‡æ›ã€Œ${displayNameFromTag(annotateTag)}ã€${spiritLine}`
        : `#${num}ï½œé»ä¸€ä¸‹åˆ‡æ›ç‹€æ…‹ï¼ˆå…± 4 ç¨®ï¼‰${spiritLine}`;

    hit.addEventListener("click", (ev) => {
      ev.stopPropagation();

      if (customEnabled && mode === "deleteMarker") {
        const ok = confirm("åˆªé™¤é€™å€‹é»ä½ï¼Ÿ");
        if (!ok) return;
        data.markers = data.markers.filter(x => x.id !== mm.id);
        save();
        render();
        return;
      }

      if (annotateMode && customEnabled && annotateTag){
        toggleMarkerTag(mm.id, annotateTag);
        save();
        updateAnnotateBar();
        render();
        return;
      }

      mm.state = (mm.state + 1) % stateIcons.length;
      save();
      render();
    });

    wrap.appendChild(ico);
    wrap.appendChild(hit);
    mapContainer.appendChild(wrap);
  });

  modeLabel.textContent =
    !customEnabled ? "ä¸€èˆ¬" :
    mode === "normal" ? "ä¸€èˆ¬ï¼ˆè‡ªå®šç¾© ONï¼‰" :
    mode === "addMarker" ? "æ–°å¢é»ä½ï¼ˆè‡ªå®šç¾©ï¼‰" : "åˆªé™¤é»ä½ï¼ˆè‡ªå®šç¾©ï¼‰";

  if (!customEnabled) mode = "normal";
  btnCustomToggleAddMarker?.classList.toggle("active", customEnabled && mode === "addMarker");
  btnCustomToggleDeleteMarker?.classList.toggle("active", customEnabled && mode === "deleteMarker");

  updateAnnotateButtonState();
}

function renderLegendAndStats(){
  if (!legendEl) return;

  const legendItems = stateIcons.map((src, i) => `
    <div class="legend-item">
      <img class="legend-icon" src="${src}" alt="ç‹€æ…‹${i}">
      <div class="legend-text">${escapeHtml(stateLegend[i] ?? `ç‹€æ…‹ ${i}`)}</div>
      <div class="legend-state">#${i}</div>
    </div>
  `).join("");

  const countsByMap = computeCountsByMap();
  const statsRows = data.maps.map(mp => {
    const c = countsByMap.get(mp.id) || { s1: 0, s3: 0 };
    return `
      <div class="stats-row">
        <div class="stats-name">${escapeHtml(mp.name || "æœªå‘½ååœ°åœ–")}</div>
        <div class="stats-counts">
          <span class="pill" title="state1 æ•¸é‡"><img src="${stateIcons[1]}" alt="s1"> ${c.s1}</span>
          <span class="pill" title="state3 æ•¸é‡"><img src="${stateIcons[3]}" alt="s3"> ${c.s3}</span>
        </div>
      </div>
    `;
  }).join("");

  const failedMaps = data.maps
    .filter(mp => (countsByMap.get(mp.id)?.s3 ?? 0) > 0)
    .map(mp => `<div class="fail-item">ä¸Šæ¬¡ã€Œ${escapeHtml(mp.name || "æœªå‘½ååœ°åœ–")}ã€æœ‰é­”éˆæ•æ‰å¤±æ•—</div>`)
    .join("");

  const failBlock = failedMaps
    ? `<div class="fail-title">æé†’</div>${failedMaps}`
    : `<div class="fail-title">æé†’</div><div class="fail-empty">ç›®å‰æ²’æœ‰é­”éˆæ•æ‰å¤±æ•—ã€‚</div>`;

  const queryBlock = buildSpiritQueryLegendBlock();

  legendEl.innerHTML = `
    <div class="legend-title">é»ä½ç‹€æ…‹</div>
    ${legendItems}
    <div class="panel-sep"></div>
    <div class="stats-title">åœ°åœ–çµ±è¨ˆ</div>
    ${statsRows}
    <div class="panel-sep"></div>
    ${queryBlock}
    <div class="panel-sep"></div>
    ${failBlock}
  `;
}

/* =====================
   æŸ¥è©¢é­”éˆï¼šæ¸²æŸ“æ¸…å–® + å³å´è³‡è¨Š
===================== */
function renderSpiritDialog(){
  const variantTabs = document.getElementById("variantTabs");
  if (variantTabs){
    variantTabs.querySelectorAll(".vtab").forEach(btn => {
      const key = btn.getAttribute("data-vf");
      btn.classList.toggle("active", key === panelVariantFilter);
      btn.onclick = () => {
        panelVariantFilter = key || DEFAULT_VARIANT;
        renderSpiritDialog();
      };
    });
  }

  const list = getFilteredSpirits();

  spiritList.innerHTML = list.length ? list.map(s => {
    const tag = tagKey(s.id, panelVariantFilter);
    const checked = panelSelectedSpiritTags.has(tag);
    const cnt = countMarkersForTag(tag);
    const overlap = countOverlapsForTag(tag);
    const disp = `${variantEmoji(panelVariantFilter)}${variantLabel(panelVariantFilter)}ï½œ${s.name || "æœªå‘½åé­”éˆ"}`;
    return `
      <div class="rowline">
        <label class="chk">
          <input type="checkbox" ${checked ? "checked" : ""} data-spirit-chk="${s.id}">
          <span class="name">${escapeHtml(disp)}</span>
        </label>
        <span class="kbadge" title="æ­¤å½¢æ…‹ç¸½ç¬¦åˆé»ä½æ•¸">ğŸ“ ${cnt}</span>
        ${overlap > 0 ? `<span class="kbadge" title="æ­¤å½¢æ…‹é‡è¤‡è¨»è¨˜é»">âš ï¸ ${overlap}</span>` : ``}
      </div>
    `;
  }).join("") : `<div class="muted">æ²’æœ‰ç¬¦åˆçš„é­”éˆã€‚</div>`;

  spiritList.querySelectorAll("input[data-spirit-chk]").forEach(inp => {
    inp.addEventListener("change", () => {
      const id = inp.getAttribute("data-spirit-chk");
      if (!id) return;
      const t = tagKey(id, panelVariantFilter);
      inp.checked ? panelSelectedSpiritTags.add(t) : panelSelectedSpiritTags.delete(t);
      renderSpiritDialog();
    });
  });

  spiritInfoBox.innerHTML = buildInfoBoxHtml();

  if (customEnabled){
    manageHintText.textContent = "å¯æ”¹åã€åˆªé™¤ã€æŒ‡å®šè¨»è¨˜ç›®æ¨™ï¼ˆè¨»è¨˜ç›®æ¨™æœƒåŒ…å«å½¢æ…‹ï¼‰ã€‚";
    spiritManageList.innerHTML = buildManageListHtml();
    bindManageListEvents();
    bindManageBulkEvents();
  } else {
    spiritManageList.innerHTML = "";
  }

  updateAnnotateButtonState();
}

function buildInfoBoxHtml(){
  const total = data.spirits.length;
  const selectedCount = Array.from(panelSelectedSpiritTags).filter(t => parseTag(t)?.variant === panelVariantFilter).length;
  const totalMatches = countMarkersForSelected(panelSelectedSpiritTags);

  return `
    <div style="display:flex; flex-wrap:wrap; gap:6px; align-items:center;">
      <span class="kbadge">é­”éˆç¸½æ•¸ï¼š${total}</span>
      <span class="kbadge">ï¼ˆ${variantEmoji(panelVariantFilter)}${variantLabel(panelVariantFilter)}ï¼‰å·²å‹¾é¸ï¼š${selectedCount}</span>
      <span class="kbadge">ç¸½ç¬¦åˆé»ä½ï¼š${totalMatches}</span>
    </div>
    <div class="panel-sep"></div>
    <div class="fail-empty">
      ç›®å‰ä½ æ­£åœ¨æŸ¥çœ‹/è¨»è¨˜çš„å½¢æ…‹æ˜¯ï¼š<b>${variantEmoji(panelVariantFilter)} ${variantLabel(panelVariantFilter)}</b><br>
      åˆ‡æ›å½¢æ…‹å¾Œï¼ŒåŒä¸€éš»é­”éˆçš„è¨»è¨˜é»æœƒç¨ç«‹è¨ˆç®—èˆ‡é¡¯ç¤ºã€‚
    </div>
  `;
}

/* âœ… ç®¡ç†æ¸…å–®ï¼šæ¯éš»é­”éˆä¸€ç­†ï¼ˆç›®æ¨™å«å½¢æ…‹ï¼‰ */
function buildManageListHtml(){
  if (!panelSpiritsDraft.length) return `<div class="muted">ç›®å‰æ²’æœ‰ä»»ä½•é­”éˆã€‚è«‹ç”¨å·¦å´ã€Œï¼‹ æ–°å¢é­”éˆã€ã€‚</div>`;

  const curTarget = parseTag(panelActiveSpiritPickTag);
  return panelSpiritsDraft.map(s => {
    const isPicked = (curTarget && curTarget.spiritId === s.id);
    const pickedVariant = isPicked ? curTarget.variant : panelVariantFilter;

    const cntAll = countMarkersForSpirit(s.id);
    const overlapAll = countOverlapsForSpirit(s.id);

    const style = isPicked ? "border-color: rgba(120,255,180,.35); box-shadow: 0 0 0 2px rgba(120,255,180,.10) inset;" : "";
    return `
      <div class="rowline" style="${style}">
        <label class="chk" style="flex:0 0 auto;">
          <input type="checkbox" data-manage-sel="${s.id}" ${panelManageDeleteIds.has(s.id) ? "checked":""} title="åŠ å…¥æ‰¹æ¬¡åˆªé™¤">
        </label>

        <button type="button" class="${isPicked ? "active" : ""}" data-pick-spirit="${s.id}">
          ğŸ¯ ${isPicked ? "è¨»è¨˜ç›®æ¨™" : "é¸æ“‡"}
        </button>

        <select data-pick-variant="${s.id}" title="è¨»è¨˜ç›®æ¨™å½¢æ…‹">
          ${SPIRIT_VARIANTS.map(opt => `
            <option value="${opt.key}" ${opt.key===pickedVariant ? "selected" : ""}>${opt.emoji} ${opt.label}</option>
          `).join("")}
        </select>

        <input type="text"
          value="${escapeHtml(s.name||"")}"
          data-rename-spirit="${s.id}"
          style="flex:1 1 auto; min-width:0;"
          title="é­”éˆåç¨±"
        >

        <span class="kbadge" title="ä¸‰å½¢æ…‹åˆè¨ˆè¨»è¨˜æ•¸">ğŸ“ ${cntAll}</span>
        ${overlapAll>0 ? `<span class="kbadge" title="ä¸‰å½¢æ…‹åˆè¨ˆé‡è¤‡é»ï¼ˆåŒå½¢æ…‹å…§ï¼‰">âš ï¸ ${overlapAll}</span>` : ``}

        <button type="button" class="danger" data-del-spirit="${s.id}">åˆªé™¤</button>
      </div>
    `;
  }).join("");
}

function updateManageSelectedBadge(){
  if (manageSelectedBadge) manageSelectedBadge.textContent = `å·²é¸ï¼š${panelManageDeleteIds.size}`;
  if (btnManageBulkDelete){
    const n = panelManageDeleteIds.size;
    btnManageBulkDelete.textContent = (n <= 1) ? "åˆªé™¤" : "æ‰¹é‡åˆªé™¤";
  }
}

function bindManageBulkEvents(){
  btnManageSelectAll.disabled = false;
  btnManageClear.disabled = false;
  btnManageBulkDelete.disabled = false;

  btnManageSelectAll.onclick = () => {
    panelManageDeleteIds = new Set(panelSpiritsDraft.map(s => s.id));
    renderSpiritDialog();
  };

  btnManageClear.onclick = () => {
    panelManageDeleteIds = new Set();
    renderSpiritDialog();
  };

  btnManageBulkDelete.onclick = () => {
    const ids = Array.from(panelManageDeleteIds);
    const n = ids.length;

    if (n === 0){
      alert("è«‹å…ˆå‹¾é¸è¦åˆªé™¤çš„é­”éˆã€‚");
      return;
    }

    const title = (n === 1) ? "åˆªé™¤" : "æ‰¹é‡åˆªé™¤";
    const names = ids.slice(0, 10).map(id => {
      const s = panelSpiritsDraft.find(x => x.id === id);
      return s?.name || "æœªå‘½å";
    }).join("\n");
    const more = n > 10 ? `\nâ€¦ä»¥åŠå…¶ä»– ${n - 10} ç­†` : "";

    const ok = confirm(`ç¢ºå®šè¦${title} ${n} ç­†é­”éˆï¼Ÿ\nï¼ˆæŒ‰ã€Œå®Œæˆã€æ‰æœƒçœŸæ­£åˆªé™¤ä¸¦ç§»é™¤é»ä½è¨»è¨˜ï¼‰\n\n${names}${more}`);
    if (!ok) return;

    ids.forEach(id => panelDeletedSpiritIds.add(id));
    panelSpiritsDraft = panelSpiritsDraft.filter(s => !panelDeletedSpiritIds.has(s.id));

    ids.forEach(id => {
      ["miracle","keen","shine"].forEach(v => panelSelectedSpiritTags.delete(tagKey(id,v)));
      if (panelActiveSpiritPickTag && parseTag(panelActiveSpiritPickTag)?.spiritId === id) panelActiveSpiritPickTag = null;
      if (annotateTag && parseTag(annotateTag)?.spiritId === id) stopAnnotateMode();
    });

    panelManageDeleteIds = new Set();
    renderSpiritDialog();
  };

  updateManageSelectedBadge();
}

function bindManageListEvents(){
  // æ‰¹æ¬¡å‹¾é¸
  spiritManageList.querySelectorAll("input[data-manage-sel]").forEach(inp => {
    inp.addEventListener("change", () => {
      const id = inp.getAttribute("data-manage-sel");
      if (!id) return;
      inp.checked ? panelManageDeleteIds.add(id) : panelManageDeleteIds.delete(id);
      updateManageSelectedBadge();
    });
  });

  // å½¢æ…‹ä¸‹æ‹‰ï¼šåªå½±éŸ¿ã€Œç›®æ¨™ã€çš„å½¢æ…‹ï¼ˆè‹¥æ­¤è¡Œæ˜¯ç›®æ¨™ï¼‰
  spiritManageList.querySelectorAll("select[data-pick-variant]").forEach(sel => {
    sel.addEventListener("change", () => {
      const id = sel.getAttribute("data-pick-variant");
      if (!id) return;
      const cur = parseTag(panelActiveSpiritPickTag);
      if (cur && cur.spiritId === id){
        panelActiveSpiritPickTag = tagKey(id, sel.value || DEFAULT_VARIANT);
        renderSpiritDialog();
      }
    });
  });

  // é¸è¨»è¨˜ç›®æ¨™ï¼šæœƒæŠŠç›®æ¨™è¨­æˆæ­¤è¡Œ + å…¶ä¸‹æ‹‰å½¢æ…‹
  spiritManageList.querySelectorAll("button[data-pick-spirit]").forEach(btn => {
    btn.addEventListener("click", () => {
      const id = btn.getAttribute("data-pick-spirit");
      if (!id) return;

      const cur = parseTag(panelActiveSpiritPickTag);
      const isSame = (cur && cur.spiritId === id);

      if (isSame){
        panelActiveSpiritPickTag = null;
        renderSpiritDialog();
        return;
      }

      const sel = spiritManageList.querySelector(`select[data-pick-variant="${CSS.escape(id)}"]`);
      const v = sel?.value || panelVariantFilter || DEFAULT_VARIANT;
      panelActiveSpiritPickTag = tagKey(id, v);
      renderSpiritDialog();
    });
  });

  // æ”¹åï¼ˆè‰ç¨¿ï¼‰
  spiritManageList.querySelectorAll("input[data-rename-spirit]").forEach(inp => {
    inp.addEventListener("input", () => {
      const id = inp.getAttribute("data-rename-spirit");
      const s = panelSpiritsDraft.find(x => x.id === id);
      if (!s) return;
      s.name = inp.value;
      renderSpiritDialog();
    });
  });

  // åˆªé™¤ï¼ˆè‰ç¨¿ï¼‰
  spiritManageList.querySelectorAll("button[data-del-spirit]").forEach(btn => {
    btn.addEventListener("click", () => {
      const id = btn.getAttribute("data-del-spirit");
      const s = panelSpiritsDraft.find(x => x.id === id);
      if (!s) return;

      if (!confirm(`ç¢ºå®šè¦åˆªé™¤é­”éˆã€Œ${escapeHtml(s.name||"æœªå‘½åé­”éˆ")}ã€ï¼Ÿ\nï¼ˆæŒ‰ã€Œå®Œæˆã€æ‰æœƒçœŸæ­£åˆªé™¤ä¸¦ç§»é™¤é»ä½è¨»è¨˜ï¼‰`)) return;

      panelDeletedSpiritIds.add(id);
      panelSpiritsDraft = panelSpiritsDraft.filter(x => x.id !== id);

      ["miracle","keen","shine"].forEach(v => panelSelectedSpiritTags.delete(tagKey(id,v)));
      if (panelActiveSpiritPickTag && parseTag(panelActiveSpiritPickTag)?.spiritId === id) panelActiveSpiritPickTag = null;

      panelManageDeleteIds.delete(id);
      renderSpiritDialog();
    });
  });

  updateManageSelectedBadge();
}

/* =====================
   å·¦å´ï¼šæŸ¥è©¢çµæœï¼ˆä½¿ç”¨å·²å¥—ç”¨ selectedSpiritTagsï¼‰
===================== */
function buildSpiritQueryLegendBlock(){
  if (selectedSpiritTags.size === 0){
    return `
      <div class="stats-title">æŸ¥è©¢é­”éˆ</div>
      <div class="fail-empty">å°šæœªå‹¾é¸ã€‚æŒ‰ä¸Šæ–¹ <b>ã€ŒğŸ” æŸ¥è©¢é­”éˆã€</b> é–‹å§‹ç¯©é¸é»ä½ã€‚</div>
    `;
  }

  const groups = new Map();
  ["miracle","keen","shine"].forEach(v => groups.set(v, []));
  for (const t of selectedSpiritTags){
    const p = parseTag(t);
    if (!p) continue;
    if (!groups.has(p.variant)) groups.set(p.variant, []);
    groups.get(p.variant).push(t);
  }

  const blocks = Array.from(groups.entries()).map(([v, tags]) => {
    if (!tags.length) return "";
    const lines = tags.map(t => {
      const hits = getAllMatchesForTag(t);
      const total = hits.reduce((sum, h) => sum + h.items.length, 0);
      const name = displayNameFromTag(t) || "æœªå‘½åé­”éˆ";

      const detail = hits.length
        ? hits.map(h => {
            const nums = h.items.map(it => `#${it.idx}`).join("ã€");
            return `<div class="fail-item" style="border-style:solid; border-color: rgba(255,255,255,.10); background: rgba(255,255,255,.03);">
              <b>${escapeHtml(h.mapName)}</b>ï¼š${escapeHtml(nums)}
            </div>`;
          }).join("")
        : `<div class="fail-empty">æ²’æœ‰ä»»ä½•é»ä½ç¬¦åˆã€‚</div>`;

      return `
        <div class="fail-item" style="border-style:solid; border-color: rgba(255,210,120,.22); background: rgba(255,255,255,.04);">
          âœ… <b>${escapeHtml(name)}</b>ï½œç¬¦åˆ <b>${total}</b> å€‹é»ä½
        </div>
        ${detail}
      `;
    }).join("");

    return `
      <div class="panel-sep"></div>
      <div class="stats-title">${variantEmoji(v)} ${variantLabel(v)}ï½œæŸ¥è©¢çµæœ</div>
      ${lines}
    `;
  }).join("");

  return `
    <div class="stats-title">æŸ¥è©¢çµæœ</div>
    <div class="fail-empty" style="margin-bottom:8px;">
      å·²å‹¾é¸ <b>${selectedSpiritTags.size}</b> å€‹ï¼ˆå«å½¢æ…‹ï¼‰ï¼Œç¸½ç¬¦åˆ <b>${countMarkersForSelected(selectedSpiritTags)}</b> å€‹é»ä½ï¼ˆæœ¬åœ°åœ–æœƒé«˜äº®é¡¯ç¤ºï¼‰ã€‚
    </div>
    ${blocks}
  `;
}

/* =====================
   è¨»è¨˜æ¨¡å¼
===================== */
function startAnnotateMode(tag){
  annotateMode = true;
  annotateTag = tag;
  annotateBar.classList.add("show");
  updateAnnotateBar();
  if (mode !== "normal") setMode("normal");
  updateAnnotateButtonState();

  // âœ…ã€é—œéµä¿®æ­£ã€‘é€²å…¥è¨»è¨˜æ¨¡å¼å¾Œç«‹åˆ»é‡ç¹ªï¼Œè®“é«˜å…‰/assign ç«‹å³å‡ºç¾ï¼ˆä¸éœ€å…ˆé»é»ä½ï¼‰
  render();
}

function stopAnnotateMode(){
  annotateMode = false;
  annotateTag = null;
  annotateBar.classList.remove("show");
  annotateTitle.textContent = "è«‹é»é¸è¦è¨»è¨˜çš„é»ä½";
  annotateDesc.textContent = "";
  annotateMini.innerHTML = "";
  updateAnnotateButtonState();
}

function updateAnnotateBar(){
  if (!annotateMode || !annotateTag) return;
  const name = displayNameFromTag(annotateTag) || "æœªå‘½åé­”éˆ";
  const total = countMarkersForTag(annotateTag);
  const overlap = countOverlapsForTag(annotateTag);

  annotateDesc.innerHTML = `
    ç›®å‰è¨»è¨˜ç›®æ¨™ï¼š<b>${escapeHtml(name)}</b> ï½œ å·²è¨»è¨˜ <b>${total}</b> å€‹é»ä½
    ${overlap > 0 ? `ï½œ å…¶ä¸­ <b>${overlap}</b> å€‹ç‚ºé‡è¤‡è¨»è¨˜é»ï¼ˆåŒå½¢æ…‹ï¼‰` : ``}
    <div style="margin-top:6px; color: rgba(255,255,255,.70);">
      ä½ å¯ä»¥åœ¨ <b>å–®æ¬¡è¨»è¨˜ç‹€æ…‹</b> ä¸‹é€£çºŒé»å¤šå€‹é»ä½ã€‚
    </div>
  `;

  const m = getCurrentMap();
  if (!m){ annotateMini.innerHTML = ""; return; }
  const arr = getMarkersInMap(m.id);
  const nums = arr
    .map((mk, i) => ({ mk, idx: i + 1 }))
    .filter(x => (x.mk.spiritTags || []).includes(annotateTag))
    .map(x => x.idx);

  annotateMini.innerHTML = nums.length
    ? nums.map(n => `<span class="assign-pill">å·²è¨»è¨˜ï¼š#${n}</span>`).join("")
    : `<span class="muted">æ­¤åœ°åœ–å°šæœªè¨»è¨˜ä»»ä½•é»ä½ã€‚</span>`;
}

/* =====================
   è¨ˆç®—/è¼”åŠ©
===================== */
function computeCountsByMap(){
  const map = new Map();
  for (const mp of data.maps) map.set(mp.id, { s1: 0, s3: 0 });
  for (const mk of data.markers) {
    const row = map.get(mk.mapId);
    if (!row) continue;
    if (mk.state === 1) row.s1 += 1;
    if (mk.state === 3) row.s3 += 1;
  }
  return map;
}

function getSpiritName(id){
  return data.spirits.find(x => x.id === id)?.name || "";
}

function displayNameFromTag(tag){
  const p = parseTag(tag);
  if (!p) return "";
  const nm = getSpiritName(p.spiritId) || "æœªå‘½åé­”éˆ";
  return `${variantEmoji(p.variant)}${variantLabel(p.variant)}ï½œ${nm}`;
}

function countMarkersForTag(tag){
  let n = 0;
  for (const mk of data.markers){
    if ((mk.spiritTags || []).includes(tag)) n++;
  }
  return n;
}

function countOverlapsForTag(tag){
  const p = parseTag(tag);
  if (!p) return 0;
  let n = 0;
  for (const mk of data.markers){
    const tags = mk.spiritTags || [];
    const sameVariant = tags.filter(t => parseTag(t)?.variant === p.variant);
    if (sameVariant.length >= 2 && tags.includes(tag)) n++;
  }
  return n;
}

function countMarkersForSelected(setTags){
  if (!setTags || setTags.size === 0) return 0;
  let n = 0;
  for (const mk of data.markers){
    const tags = mk.spiritTags || [];
    for (const t of tags){
      if (setTags.has(t)) { n++; break; }
    }
  }
  return n;
}

function isMarkerMatchedBySelected(marker){
  const tags = marker.spiritTags || [];
  for (const t of tags){
    if (selectedSpiritTags.has(t)) return true;
  }
  return false;
}

function toggleMarkerTag(markerId, tag){
  const mk = data.markers.find(m => m.id === markerId);
  if (!mk) return;
  mk.spiritTags = mk.spiritTags || [];
  const has = mk.spiritTags.includes(tag);
  mk.spiritTags = has ? mk.spiritTags.filter(x => x !== tag) : mk.spiritTags.concat([tag]);
}

function getMarkersInMap(mapId){
  return data.markers
    .filter(mk => mk.mapId === mapId)
    .slice()
    .sort((a,b) => (a.createdAt||0) - (b.createdAt||0));
}

function getAllMatchesForTag(tag){
  const res = [];
  for (const mp of data.maps){
    const arr = getMarkersInMap(mp.id)
      .map((mk, i) => ({ mk, idx: i + 1 }))
      .filter(x => (x.mk.spiritTags || []).includes(tag))
      .map(x => ({ mid: x.mk.id, idx: x.idx }));
    if (arr.length) res.push({ mapId: mp.id, mapName: mp.name || "æœªå‘½ååœ°åœ–", items: arr });
  }
  return res;
}

function getSpiritNamesByMarker(marker){
  return (marker.spiritTags || []).map(t => displayNameFromTag(t)).filter(Boolean);
}

/* âœ… ç®¡ç†çµ±è¨ˆï¼šä¸‰å½¢æ…‹åˆè¨ˆ */
function countMarkersForSpirit(spiritId){
  let n = 0;
  for (const mk of data.markers){
    const tags = mk.spiritTags || [];
    if (tags.some(t => parseTag(t)?.spiritId === spiritId)) n++;
  }
  return n;
}
function countOverlapsForSpirit(spiritId){
  let n = 0;
  for (const mk of data.markers){
    const tags = mk.spiritTags || [];
    const variants = ["miracle","keen","shine"];
    let overlapped = false;
    for (const v of variants){
      const sameV = tags.filter(t => parseTag(t)?.variant === v);
      if (sameV.length >= 2){
        if (tags.some(t => parseTag(t)?.spiritId === spiritId)) overlapped = true;
      }
    }
    if (overlapped) n++;
  }
  return n;
}

/* =====================
   åœ°åœ–/è³‡æ–™
===================== */
function renderMapSelect(preserveSelection = false){
  const current = data.currentMapId;
  mapSelect.innerHTML = "";
  data.maps.forEach((m, i) => {
    const opt = document.createElement("option");
    opt.value = m.id;
    opt.textContent = m.name || `åœ°åœ– ${i + 1}`;
    mapSelect.appendChild(opt);
  });
  if (preserveSelection && current) mapSelect.value = current;
  if (!preserveSelection && data.currentMapId) mapSelect.value = data.currentMapId;
}
function syncCurrentMapUI(){
  const m = getCurrentMap();
  mapNameInput.value = m?.name || "";
  if (m?.id) mapSelect.value = m.id;
}
function setMode(next){
  if (!customEnabled) { mode = "normal"; render(); return; }
  mode = next;
  render();
}
function save(){
  try { localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); }
  catch { alert("ä¿å­˜å¤±æ•—ï¼šlocalStorage ç©ºé–“å¯èƒ½ä¸å¤ ï¼ˆåœ°åœ–åœ–ç‰‡å¤ªå¤§ï¼‰ã€‚"); }
}
function load(){
  const raw = localStorage.getItem(STORAGE_KEY);
  if (!raw) return;
  try {
    const parsed = JSON.parse(raw);
    if (parsed?.maps && parsed?.markers) data = parsed;
  } catch {}
}

function buildExportLiteData(){
  const lite = {
    maps: [],
    markers: data.markers.map(mk => ({ ...mk })),
    spirits: (data.spirits || []).map(s => ({ ...s })),
    currentMapId: data.currentMapId
  };
  for (const mp of data.maps) {
    const isBase64 = typeof mp.src === "string" && mp.src.startsWith("data:image/");
    if (!ALLOW_EXPORT_BASE64_MAPS && isBase64) lite.maps.push({ id: mp.id, name: mp.name, src: "", needsMapUpload: true });
    else lite.maps.push({ id: mp.id, name: mp.name, src: mp.src, needsMapUpload: !!mp.needsMapUpload });
  }
  return lite;
}

function assertValidData(d){
  if (!d || typeof d !== "object") throw new Error("data not object");
  if (!Array.isArray(d.maps) || !Array.isArray(d.markers)) throw new Error("missing maps/markers");
  if (!Array.isArray(d.spirits)) d.spirits = [];
  for (const m of d.maps) {
    if (typeof m.id !== "string") throw new Error("map.id missing");
    if (typeof m.name !== "string") m.name = "æœªå‘½ååœ°åœ–";
    if (typeof m.src !== "string") m.src = "";
    if (typeof m.needsMapUpload !== "boolean") m.needsMapUpload = (m.src === "");
  }
  for (const s of d.spirits){
    if (typeof s.id !== "string") throw new Error("spirit.id missing");
    if (typeof s.name !== "string") s.name = "æœªå‘½åé­”éˆ";
  }
  for (const mk of d.markers) {
    if (typeof mk.id !== "string") throw new Error("marker.id missing");
    if (typeof mk.mapId !== "string") throw new Error("marker.mapId missing");
    if (typeof mk.x !== "number" || typeof mk.y !== "number") throw new Error("marker.x/y missing");
    if (typeof mk.state !== "number") mk.state = 0;
    mk.state = ((mk.state % stateIcons.length) + stateIcons.length) % stateIcons.length;
    mk.x = clamp01(mk.x); mk.y = clamp01(mk.y);
    if (typeof mk.createdAt !== "number") mk.createdAt = Date.now();
    if (!Array.isArray(mk.spiritTags)) mk.spiritTags = [];
  }
  const mapIds = new Set(d.maps.map(m => m.id));
  d.markers = d.markers.filter(mk => mapIds.has(mk.mapId));
}

function repairDataShapeAndMigrate(){
  if (!Array.isArray(data.spirits)) data.spirits = [];
  if (!Array.isArray(data.markers)) data.markers = [];
  if (!Array.isArray(data.maps)) data.maps = [];

  // marker: spiritIds(èˆŠ) -> spiritTags(æ–°)
  data.markers.forEach(mk => {
    if (!Array.isArray(mk.spiritTags)) mk.spiritTags = [];
    if (Array.isArray(mk.spiritIds) && mk.spiritIds.length){
      mk.spiritIds.forEach(id => mk.spiritTags.push(tagKey(id, DEFAULT_VARIANT)));
      delete mk.spiritIds;
    }
  });

  // æ¸…ç†èˆŠ spirits çš„ variantï¼ˆæœ¬ç‰ˆ spirits åªä¿ç•™ id/nameï¼‰
  data.spirits.forEach(s => {
    if (!s.id) s.id = uid();
    if (!s.name) s.name = "æœªå‘½åé­”éˆ";
    delete s.variant;
  });

  let t = Date.now();
  data.markers.forEach(mk => {
    if (typeof mk.createdAt !== "number") mk.createdAt = (t += 1);
    if (!Array.isArray(mk.spiritTags)) mk.spiritTags = [];
  });

  const spiritIds = new Set(data.spirits.map(s => s.id));
  data.markers.forEach(mk => {
    mk.spiritTags = (mk.spiritTags || []).filter(tag => {
      const p = parseTag(tag);
      return p && spiritIds.has(p.spiritId);
    });
  });

  if (data.currentMapId && !data.maps.some(m => m.id === data.currentMapId)) data.currentMapId = data.maps[0]?.id ?? null;

  // æ¸…ç†ç›®æ¨™æŒ‡å‘ä¸å­˜åœ¨
  if (activeSpiritPickTag && !spiritIds.has(parseTag(activeSpiritPickTag)?.spiritId)) activeSpiritPickTag = null;
  if (panelActiveSpiritPickTag && !spiritIds.has(parseTag(panelActiveSpiritPickTag)?.spiritId)) panelActiveSpiritPickTag = null;
}

/* =====================
   å·¥å…·å‡½å¼
===================== */
function getCurrentMap(){ return data.maps.find(m => m.id === data.currentMapId) || null; }
function uid(){ return (crypto?.randomUUID?.() || ("id_" + Math.random().toString(16).slice(2) + Date.now())); }
function clamp01(n){ return Math.min(1, Math.max(0, n)); }
function escapeHtml(s){
  return String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
    .replaceAll('"',"&quot;").replaceAll("'","&#039;");
}
function formatDateForFile(dt){
  const y = dt.getFullYear();
  const m = String(dt.getMonth() + 1).padStart(2, "0");
  const d = String(dt.getDate()).padStart(2, "0");
  const hh = String(dt.getHours()).padStart(2, "0");
  const mm = String(dt.getMinutes()).padStart(2, "0");
  return `${y}${m}${d}-${hh}${mm}`;
}
function formatBytes(bytes){
  const units = ["B", "KB", "MB", "GB"];
  let n = bytes, i = 0;
  while (n >= 1024 && i < units.length - 1) { n /= 1024; i++; }
  return `${n.toFixed(i === 0 ? 0 : 2)} ${units[i]}`;
}
function initDragSort(listEl){
  const items = Array.from(listEl.querySelectorAll("li"));
  let dragging = null;
  items.forEach(li => {
    li.addEventListener("dragstart", () => { dragging = li; li.classList.add("dragging"); });
    li.addEventListener("dragend", () => { li.classList.remove("dragging"); dragging = null; });
    li.addEventListener("dragover", (e) => {
      e.preventDefault();
      if (!dragging || li === dragging) return;
      const rect = li.getBoundingClientRect();
      const after = e.clientY > rect.top + rect.height / 2;
      listEl.insertBefore(dragging, after ? li.nextSibling : li);
    });
  });
}

/* =====================
   ä¸‹æ‹‰é¸å–®
===================== */
(function initDropdowns(){
  const dropdowns = Array.from(document.querySelectorAll("[data-dd]"));
  function closeAll(except=null){
    dropdowns.forEach(dd => {
      if (dd === except) return;
      dd.classList.remove("open");
      const btn = dd.querySelector(".menu-btn");
      if (btn) btn.setAttribute("aria-expanded", "false");
    });
  }
  dropdowns.forEach(dd => {
    const btn = dd.querySelector(".menu-btn");
    const menu = dd.querySelector(".menu");
    if (!btn || !menu) return;
    btn.addEventListener("click", (e) => {
      e.stopPropagation();
      const isOpen = dd.classList.contains("open");
      if (isOpen) { dd.classList.remove("open"); btn.setAttribute("aria-expanded", "false"); }
      else { closeAll(dd); dd.classList.add("open"); btn.setAttribute("aria-expanded", "true"); }
    });
    menu.addEventListener("click", (e) => {
      const target = e.target;
      if (target && target.tagName === "BUTTON") { dd.classList.remove("open"); btn.setAttribute("aria-expanded", "false"); }
    });
  });
  document.addEventListener("click", () => closeAll(null));
  document.addEventListener("keydown", (e) => { if (e.key === "Escape") closeAll(null); });
})();
</script>
</body>
</html>
